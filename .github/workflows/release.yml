name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for release notes generation

      - name: Generate release notes from git log
        id: notes
        run: |
          TAG="${GITHUB_REF#refs/tags/}"

          # Find previous tag
          PREV_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]' | sed -n '2p')

          if [ -z "$PREV_TAG" ]; then
            # No previous tag, use all commits
            COMMITS=$(git log --pretty=format:"- %s" --no-merges HEAD~20..HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s" --no-merges "${PREV_TAG}..${TAG}")
          fi

          # Build release body
          {
            echo "body<<RELEASE_EOF"
            echo "## Remote Desktop ${TAG}"
            echo ""
            echo "### Changes since ${PREV_TAG:-inception}"
            echo ""
            echo "${COMMITS}"
            echo ""
            echo "---"
            echo ""
            echo "### Downloads"
            echo ""
            echo "Windows installer og exe-filer: https://updates.hawkeye123.dk"
            echo ""
            echo "| Fil | Beskrivelse |"
            echo "|-----|-------------|"
            echo "| RemoteDesktopAgent-Setup.exe | Agent installer (GUI + Console + OpenH264) |"
            echo "| RemoteDesktopController-Setup.exe | Controller installer (Controller + FFmpeg) |"
            echo "| remote-agent.exe | Agent standalone (GUI mode) |"
            echo "| remote-agent-console.exe | Agent standalone (Console mode) |"
            echo "| controller.exe | Controller standalone |"
            echo ""
            echo "### System Requirements"
            echo ""
            echo "- Windows 10/11 (64-bit)"
            echo "- macOS 13+ (Apple Silicon / Intel)"
            echo "RELEASE_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.notes.outputs.body }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
