name: Build and Release Agent

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: |
            agent/go.sum

      - name: Install MinGW (GCC for Windows)
        run: |
          choco install mingw -y
          refreshenv

      - name: Tidy Go modules
        working-directory: ./agent
        run: |
          go mod tidy
          go mod download

      - name: Build Agent
        working-directory: ./agent
        env:
          CGO_ENABLED: 1
        run: |
          go build -mod=mod -ldflags "-s -w -H windowsgui" -o remote-agent.exe ./cmd/remote-agent

      - name: Get version from tag
        id: get_version
        run: |
          $version = $env:GITHUB_REF -replace 'refs/tags/', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Create ZIP with installation scripts
        working-directory: ./agent
        run: |
          $files = @(
            "remote-agent.exe",
            "setup-startup.bat",
            "uninstall-service.bat",
            "view-logs.bat"
          )
          Compress-Archive -Path $files -DestinationPath remote-agent-windows.zip
        shell: pwsh

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Remote Desktop Agent ${{ steps.get_version.outputs.version }}
          body: |
            ## ðŸŽ‰ Remote Desktop Agent ${{ steps.get_version.outputs.version }}
            
            ### ðŸ†• What's New in v0.2.0
            
            - **Anonymous Registration**: No login required! Just run the agent
            - **Auto-Registration**: Automatically registers on startup
            - **Persistent Device ID**: Stable ID across restarts (Registry + File)
            - **Admin Assignment**: Waits for admin to assign device to user
            - **Improved Heartbeat**: Better presence detection
            
            ### ðŸ“¥ Installation
            
            1. Download `remote-agent.exe` or `remote-agent-windows.zip`
            2. Run `remote-agent.exe` - it will auto-register!
            3. Admin assigns device via admin panel
            4. (Optional) Run `setup-startup.bat` to start on boot
            
            ### âœ¨ Features
            
            - âœ… Anonymous device registration (no login needed)
            - âœ… Persistent device ID
            - âœ… Auto-registration on startup
            - âœ… High-quality screen streaming (1920px @ 15 FPS)
            - âœ… Low latency WebRTC connection
            - âœ… Mouse and keyboard control
            - âœ… Automatic reconnection
            - âœ… Clean session management
            
            ### ðŸ“‹ System Requirements
            
            - Windows 10/11
            - .NET Framework 4.7.2 or higher
            - Active internet connection
            
            ### ðŸ”§ How It Works
            
            1. Agent generates unique device ID
            2. Registers anonymously with Supabase
            3. Shows "Waiting for admin assignment" message
            4. Admin assigns device to user via admin panel
            5. User can now connect via controller app
            
            For full documentation, see the [README](https://github.com/stangtennis/Remote/blob/main/README.md).
          files: |
            ./agent/remote-agent.exe
            ./agent/remote-agent-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
