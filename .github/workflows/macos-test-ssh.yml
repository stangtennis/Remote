name: macOS Agent E2E Test

on:
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  macos-agent:
    runs-on: macos-14  # Apple Silicon M1
    timeout-minutes: 360
    steps:
      - name: Checkout kode
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: false

      - name: System info
        run: |
          echo "=== System ==="
          uname -a
          sw_vers
          sysctl -n machdep.cpu.brand_string
          echo "Display: $(system_profiler SPDisplaysDataType 2>/dev/null | grep Resolution || echo 'N/A')"

      - name: Byg macOS agent
        run: |
          cd agent
          go mod download
          CGO_ENABLED=1 GOOS=darwin GOARCH=arm64 go build -o remote-agent-macos ./cmd/remote-agent/
          file remote-agent-macos
          ls -lh remote-agent-macos

      - name: Authenticer agent via Supabase API
        env:
          AGENT_EMAIL: ${{ secrets.AGENT_EMAIL }}
          AGENT_PASSWORD: ${{ secrets.AGENT_PASSWORD }}
        run: |
          SUPABASE_URL="https://supabase.hawkeye123.dk"
          ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE"

          # Login via Supabase Auth
          RESPONSE=$(curl -s "$SUPABASE_URL/auth/v1/token?grant_type=password" \
            -H "apikey: $ANON_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$AGENT_EMAIL\",\"password\":\"$AGENT_PASSWORD\"}")

          ACCESS_TOKEN=$(echo "$RESPONSE" | python3 -c "import json,sys; print(json.load(sys.stdin)['access_token'])")
          REFRESH_TOKEN=$(echo "$RESPONSE" | python3 -c "import json,sys; print(json.load(sys.stdin)['refresh_token'])")
          USER_ID=$(echo "$RESPONSE" | python3 -c "import json,sys; print(json.load(sys.stdin)['user']['id'])")
          EXPIRES_IN=$(echo "$RESPONSE" | python3 -c "import json,sys; print(json.load(sys.stdin)['expires_in'])")
          EXPIRES_AT=$(python3 -c "import time; print(int(time.time()) + $EXPIRES_IN)")

          echo "User ID: $USER_ID"
          echo "Token expires in: ${EXPIRES_IN}s"

          # Gem credentials i macOS path
          CRED_DIR="$HOME/Library/Application Support/RemoteDesktopAgent"
          mkdir -p "$CRED_DIR"
          cat > "$CRED_DIR/.credentials" << CREDEOF
          {
            "email": "$AGENT_EMAIL",
            "access_token": "$ACCESS_TOKEN",
            "refresh_token": "$REFRESH_TOKEN",
            "user_id": "$USER_ID",
            "expires_at": $EXPIRES_AT
          }
          CREDEOF
          echo "Credentials gemt i: $CRED_DIR/.credentials"

      - name: Start agent og vent på forbindelse
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd agent
          echo "=== Starter macOS agent i console mode ==="
          echo "Agent lytter efter WebRTC sessions fra controller..."
          echo ""

          # Start tmate for debugging
          brew install tmate 2>/dev/null || true
          tmate -S /tmp/tmate.sock new-session -d
          sleep 10
          SSH_LINE=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          WEB_LINE=$(tmate -S /tmp/tmate.sock display -p '#{tmate_web}')

          # Post SSH info som issue
          gh issue create \
            --title "macOS Agent E2E Test (live)" \
            --body "## macOS M1 Agent - Klar til E2E test

          Agent kører på macOS 14 M1 og lytter efter WebRTC sessions.

          **Forbind fra controller på win-test!**

          ### SSH debugging
          \`\`\`
          $SSH_LINE
          \`\`\`
          Web: $WEB_LINE

          ### Agent logs
          Kør \`tail -f /tmp/agent.log\` via SSH for live logs.

          > Lukkes automatisk når workflow stopper." || echo "Issue creation failed"

          # Start agent i baggrunden med log
          ./remote-agent-macos --console > /tmp/agent.log 2>&1 &
          AGENT_PID=$!
          echo "Agent PID: $AGENT_PID"
          sleep 5

          # Vis første logs
          echo "=== Agent startup logs ==="
          cat /tmp/agent.log
          echo ""
          echo "=== Agent kører. Forbind fra controller! ==="
          echo "Opret /tmp/continue for at afslutte."

          # Vent — vis agent logs hver 30 sek
          while [ ! -f /tmp/continue ]; do
            sleep 30
            if ! kill -0 $AGENT_PID 2>/dev/null; then
              echo "Agent crashede! Logs:"
              cat /tmp/agent.log
              break
            fi
            echo "--- $(date) --- Agent alive (PID $AGENT_PID) ---"
            tail -5 /tmp/agent.log
          done

          kill $AGENT_PID 2>/dev/null || true

      - name: Luk issue
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE=$(gh issue list --state open --json number,title --jq '.[] | select(.title | test("macOS Agent")) | .number' 2>/dev/null | head -1)
          if [ -n "$ISSUE" ]; then
            gh issue close "$ISSUE" --comment "Test afsluttet." || true
          fi
