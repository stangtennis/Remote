name: Build macOS Agent + Controller

on:
  push:
    branches: [main]
    paths:
      - 'agent/**'
      - 'controller/**'
      - '.github/workflows/build-macos.yml'
  pull_request:
    branches: [main]
    paths:
      - 'agent/**'
      - 'controller/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2.74.0)'
        required: true
        default: 'dev'

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon M1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: |
            agent/go.sum
            controller/go.sum

      - name: Tidy Agent Go modules
        working-directory: ./agent
        run: |
          go mod tidy
          go mod download

      - name: Tidy Controller Go modules
        working-directory: ./controller
        run: |
          go mod tidy
          go mod download

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ] && [ "${{ github.event.inputs.version }}" != "dev" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=$(git describe --tags --always 2>/dev/null || echo 'dev')" >> $GITHUB_OUTPUT
          fi

      - name: Build Agent (macOS arm64)
        working-directory: ./agent
        env:
          CGO_ENABLED: 1
          GOARCH: arm64
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_DATE=$(date +%Y-%m-%d)
          LDFLAGS="-s -w -X 'github.com/stangtennis/remote-agent/internal/tray.Version=${VERSION}' -X 'github.com/stangtennis/remote-agent/internal/tray.BuildDate=${BUILD_DATE}'"
          go build -ldflags "${LDFLAGS}" -o ../builds/remote-agent-macos-arm64-${VERSION} ./cmd/remote-agent
          echo "Built remote-agent-macos-arm64-${VERSION}"
          file ../builds/remote-agent-macos-arm64-${VERSION}

      - name: Build Controller (macOS arm64)
        working-directory: ./controller
        env:
          CGO_ENABLED: 1
          GOARCH: arm64
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_DATE=$(date +%Y-%m-%d)
          LDFLAGS="-s -w -X 'main.Version=${VERSION}' -X 'main.BuildDate=${BUILD_DATE}'"
          go build -ldflags "${LDFLAGS}" -o ../builds/controller-macos-arm64-${VERSION} .
          echo "Built controller-macos-arm64-${VERSION}"
          file ../builds/controller-macos-arm64-${VERSION}

      - name: Test build runs
        working-directory: ./builds
        run: |
          chmod +x remote-agent-* controller-*
          ./remote-agent-macos-arm64-${{ steps.version.outputs.version }} --help || true
          ./controller-macos-arm64-${{ steps.version.outputs.version }} --help || true

      - name: Run Agent unit tests
        working-directory: ./agent
        run: |
          echo "=== Testing input package (keyboard mapping, mouse helpers) ==="
          go test ./internal/input/... -v -count=1

          echo "=== Testing desktop package (macOS stubs) ==="
          go test ./internal/desktop/... -v -count=1

          echo "=== Testing device package (device ID, platform) ==="
          go test ./internal/device/... -v -count=1

          echo "=== Testing service package (launchd plist) ==="
          go test ./internal/service/... -v -count=1

          echo "=== Testing screen package (display enumeration) ==="
          go test ./internal/screen/... -v -count=1

      - name: Run Controller unit tests
        working-directory: ./controller
        run: |
          go test ./internal/updater/... -v -count=1

      - name: Upload Agent artifact
        uses: actions/upload-artifact@v4
        with:
          name: remote-agent-macos-arm64
          path: builds/remote-agent-*
          retention-days: 30

      - name: Upload Controller artifact
        uses: actions/upload-artifact@v4
        with:
          name: controller-macos-arm64
          path: builds/controller-*
          retention-days: 30
