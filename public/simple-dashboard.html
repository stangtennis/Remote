<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Remote Desktop Dashboard - TeamViewer Style</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; min-height: 100vh; padding: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            text-align: center; margin-bottom: 30px;
            background: rgba(255,255,255,0.1); padding: 20px;
            border-radius: 15px; backdrop-filter: blur(10px);
        }
        
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        
        .main-content {
            display: grid; grid-template-columns: 350px 1fr;
            gap: 20px; height: calc(100vh - 200px);
        }
        
        .devices-panel {
            background: rgba(255,255,255,0.1); border-radius: 15px;
            padding: 20px; backdrop-filter: blur(10px);
        }
        
        .devices-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
        }
        
        .devices-header h2 { font-size: 1.3rem; }
        
        .refresh-btn {
            background: #10b981; border: none; color: white;
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-size: 0.9rem; transition: all 0.3s;
        }
        
        .refresh-btn:hover { background: #059669; }
        
        .device-list { max-height: calc(100vh - 300px); overflow-y: auto; }
        
        .device-item {
            background: rgba(255,255,255,0.1); border-radius: 10px;
            padding: 15px; margin-bottom: 10px; cursor: pointer;
            transition: all 0.3s; border: 2px solid transparent;
        }
        
        .device-item:hover { background: rgba(255,255,255,0.2); }
        .device-item.selected { border-color: #10b981; background: rgba(16,185,129,0.2); }
        
        .device-name { font-weight: 600; font-size: 1.1rem; margin-bottom: 5px; }
        .device-info { font-size: 0.9rem; opacity: 0.8; margin-bottom: 3px; }
        .device-status { font-size: 0.85rem; }
        
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }
        
        .control-panel {
            background: rgba(255,255,255,0.1); border-radius: 15px;
            padding: 20px; backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
        }
        
        .control-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
        }
        
        .control-buttons {
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px;
            cursor: pointer; font-weight: 600; transition: all 0.3s;
        }
        
        .btn-primary { background: #4f46e5; color: white; }
        .btn-primary:hover { background: #3730a3; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .screen-container {
            flex: 1; background: #000; border-radius: 10px;
            margin-top: 20px; position: relative; overflow: hidden;
            min-height: 400px; display: flex; align-items: center; justify-content: center;
        }
        
        .screen-canvas {
            max-width: 100%; max-height: 100%; cursor: crosshair;
        }
        
        .no-connection {
            color: #888; text-align: center; font-size: 1.2rem;
        }
        
        .status-bar {
            background: rgba(0,0,0,0.3); padding: 10px;
            border-radius: 8px; margin-top: 15px;
            font-family: monospace; font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center; color: #888; padding: 40px;
        }
        
        .loading { text-align: center; padding: 20px; }
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #10b981;
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Remote Desktop Dashboard</h1>
            <p>Connect and control remote computers - TeamViewer style</p>
        </div>
        
        <div class="main-content">
            <!-- Devices Panel -->
            <div class="devices-panel">
                <div class="devices-header">
                    <h2>üì± Online Devices</h2>
                    <button class="refresh-btn" onclick="refreshDevices()">üîÑ Refresh</button>
                </div>
                
                <div class="device-list" id="deviceList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>Loading devices...</div>
                    </div>
                </div>
            </div>
            
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-header">
                    <h2 id="controlTitle">üéÆ Remote Control</h2>
                    <div class="control-buttons">
                        <button class="btn btn-success" onclick="connectToDevice()" id="connectBtn" disabled>
                            üîó Connect
                        </button>
                        <button class="btn btn-primary" onclick="startScreenShare()" id="screenBtn" disabled>
                            üì∫ View Screen
                        </button>
                        <button class="btn btn-danger" onclick="disconnect()" id="disconnectBtn" disabled>
                            üîå Disconnect
                        </button>
                    </div>
                </div>
                
                <div class="screen-container" id="screenContainer">
                    <div class="no-connection" id="noConnection">
                        üì∫ Select a device to start remote control<br>
                        <small>Choose from the online devices on the left</small>
                    </div>
                    <canvas id="screenCanvas" class="screen-canvas" style="display: none;"></canvas>
                </div>
                
                <div class="status-bar" id="statusBar">
                    <strong>Status:</strong> <span id="connectionStatus">No device selected</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ptrtibzwokjcjjxvjpin.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0cnRpYnp3b2tqY2pqeHZqcGluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2NzU5NzEsImV4cCI6MjA1MTI1MTk3MX0.TKzqpCqnhJMJzGHlxJz8X2vZ8FhqJhqJhqJhqJhqJhqJ';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let selectedDevice = null;
        let websocket = null;
        let isConnected = false;
        let screenCanvas = null;
        let screenContext = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Dashboard initializing...');
            
            // Setup canvas
            screenCanvas = document.getElementById('screenCanvas');
            screenContext = screenCanvas.getContext('2d');
            
            // Setup mouse events for remote control
            setupMouseEvents();
            
            // Load devices
            await loadDevices();
            
            // Setup real-time updates
            setupRealTimeUpdates();
            
            console.log('‚úÖ Dashboard ready');
        });
        
        // Load online devices
        async function loadDevices() {
            try {
                const { data: devices, error } = await supabase
                    .from('remote_devices')
                    .select('*')
                    .eq('is_online', true)
                    .order('last_seen', { ascending: false });
                
                if (error) throw error;
                
                displayDevices(devices || []);
                
            } catch (error) {
                console.error('‚ùå Failed to load devices:', error.message);
                document.getElementById('deviceList').innerHTML = `
                    <div class="empty-state">
                        ‚ùå Failed to load devices<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        // Display devices in the list
        function displayDevices(devices) {
            const deviceList = document.getElementById('deviceList');
            
            if (devices.length === 0) {
                deviceList.innerHTML = `
                    <div class="empty-state">
                        üì± No devices online<br>
                        <small>Start a remote client to see it here</small>
                    </div>
                `;
                return;
            }
            
            deviceList.innerHTML = devices.map(device => `
                <div class="device-item" onclick="selectDevice('${device.id}')" data-device-id="${device.id}">
                    <div class="device-name">üíª ${device.device_name}</div>
                    <div class="device-info">üÜî ${device.id}</div>
                    <div class="device-info">üåê ${device.ip_address}</div>
                    <div class="device-info">üíæ ${device.operating_system}</div>
                    <div class="device-info">üì° ${device.mode} mode</div>
                    <div class="device-status status-online">üü¢ Online (${formatTime(device.last_seen)})</div>
                </div>
            `).join('');
        }
        
        // Select a device
        function selectDevice(deviceId) {
            // Remove previous selection
            document.querySelectorAll('.device-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select new device
            const deviceElement = document.querySelector(`[data-device-id="${deviceId}"]`);
            if (deviceElement) {
                deviceElement.classList.add('selected');
                selectedDevice = deviceId;
                
                const deviceName = deviceElement.querySelector('.device-name').textContent;
                document.getElementById('controlTitle').textContent = `üéÆ Control: ${deviceName}`;
                document.getElementById('connectionStatus').textContent = `Selected: ${deviceName}`;
                
                // Enable connect button
                document.getElementById('connectBtn').disabled = false;
                
                console.log(`üì± Selected device: ${deviceId}`);
            }
        }
        
        // Connect to selected device
        async function connectToDevice() {
            if (!selectedDevice) {
                alert('Please select a device first');
                return;
            }
            
            try {
                // Get device info
                const { data: device, error } = await supabase
                    .from('remote_devices')
                    .select('*')
                    .eq('id', selectedDevice)
                    .single();
                
                if (error) throw error;
                
                // Connect via WebSocket
                const wsUrl = `ws://${device.ip_address}:${device.local_port || 8080}`;
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = () => {
                    console.log('‚úÖ Connected to device');
                    isConnected = true;
                    updateConnectionStatus('Connected');
                    updateButtons();
                };
                
                websocket.onmessage = (event) => {
                    handleDeviceMessage(JSON.parse(event.data));
                };
                
                websocket.onclose = () => {
                    console.log('üîå Disconnected from device');
                    isConnected = false;
                    updateConnectionStatus('Disconnected');
                    updateButtons();
                };
                
                websocket.onerror = (error) => {
                    console.error('‚ùå WebSocket error:', error);
                    updateConnectionStatus('Connection failed');
                };
                
                updateConnectionStatus('Connecting...');
                
            } catch (error) {
                console.error('‚ùå Failed to connect:', error.message);
                alert(`Failed to connect: ${error.message}`);
            }
        }
        
        // Handle messages from device
        function handleDeviceMessage(message) {
            switch (message.type) {
                case 'screen-frame':
                    displayScreenFrame(message.data);
                    break;
                    
                default:
                    console.log('üì® Device message:', message.type);
            }
        }
        
        // Display screen frame
        function displayScreenFrame(frameData) {
            const img = new Image();
            img.onload = () => {
                screenCanvas.width = img.width;
                screenCanvas.height = img.height;
                screenContext.drawImage(img, 0, 0);
            };
            img.src = `data:image/jpeg;base64,${frameData}`;
        }
        
        // Start screen sharing
        function startScreenShare() {
            if (!isConnected) {
                alert('Please connect to a device first');
                return;
            }
            
            // Show canvas
            document.getElementById('noConnection').style.display = 'none';
            document.getElementById('screenCanvas').style.display = 'block';
            
            // Request screen sharing
            websocket.send(JSON.stringify({
                type: 'start-screen-share'
            }));
            
            updateConnectionStatus('Screen sharing active');
            console.log('üì∫ Screen sharing started');
        }
        
        // Setup mouse events for remote control
        function setupMouseEvents() {
            screenCanvas.addEventListener('mousemove', (e) => {
                if (isConnected) {
                    const rect = screenCanvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left) * (screenCanvas.width / rect.width);
                    const y = (e.clientY - rect.top) * (screenCanvas.height / rect.height);
                    
                    websocket.send(JSON.stringify({
                        type: 'mouse-move',
                        x: Math.round(x),
                        y: Math.round(y)
                    }));
                }
            });
            
            screenCanvas.addEventListener('click', (e) => {
                if (isConnected) {
                    const rect = screenCanvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left) * (screenCanvas.width / rect.width);
                    const y = (e.clientY - rect.top) * (screenCanvas.height / rect.height);
                    
                    websocket.send(JSON.stringify({
                        type: 'mouse-click',
                        x: Math.round(x),
                        y: Math.round(y),
                        button: 'left'
                    }));
                }
            });
        }
        
        // Disconnect from device
        function disconnect() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            isConnected = false;
            document.getElementById('noConnection').style.display = 'block';
            document.getElementById('screenCanvas').style.display = 'none';
            updateConnectionStatus('Disconnected');
            updateButtons();
        }
        
        // Setup real-time updates for device list
        function setupRealTimeUpdates() {
            supabase
                .channel('devices')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'remote_devices' },
                    () => {
                        console.log('üîÑ Device list updated');
                        loadDevices();
                    }
                )
                .subscribe();
        }
        
        // Utility functions
        function refreshDevices() {
            loadDevices();
        }
        
        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }
        
        function updateButtons() {
            document.getElementById('connectBtn').disabled = !selectedDevice || isConnected;
            document.getElementById('screenBtn').disabled = !isConnected;
            document.getElementById('disconnectBtn').disabled = !isConnected;
        }
        
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (websocket) {
                websocket.close();
            }
        });
    </script>
</body>
</html>
