<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Simple Agent Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
        }
        .btn:hover {
            background: #3730a3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .download-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
        }
        .code-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Simple Agent Generator</h1>
        
        <div class="form-group">
            <label for="deviceName">Device Name:</label>
            <input type="text" id="deviceName" placeholder="e.g., MyTestPC" value="TestPC">
        </div>
        
        <div class="form-group">
            <label for="platform">Platform:</label>
            <select id="platform">
                <option value="windows">Windows (.bat)</option>
                <option value="macos">macOS (.sh)</option>
                <option value="linux">Linux (.sh)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="orgId">Organization ID:</label>
            <input type="text" id="orgId" placeholder="default" value="default">
        </div>
        
        <button class="btn" onclick="generateAgent()">üöÄ Generate Agent</button>
        
        <div id="result" class="result"></div>
    </div>

    <script>
        console.log('Simple Agent Generator loaded');
        
        function generateAgent() {
            console.log('Generate button clicked');
            
            const deviceName = document.getElementById('deviceName').value || 'TestPC';
            const platform = document.getElementById('platform').value;
            const orgId = document.getElementById('orgId').value || 'default';
            const result = document.getElementById('result');
            
            console.log('Generating agent for:', { deviceName, platform, orgId });
            
            try {
                // Generate the real Node.js agent
                const agentContent = generateRealAgent(deviceName, platform, orgId);
                const packageContent = generatePackageJson(deviceName);
                const startScript = generateStartScript(deviceName, platform);
                
                // Create downloads for all files
                createAgentDownloads(deviceName, platform, agentContent, packageContent, startScript, result);
                
                console.log('‚úÖ Real agent generated successfully');
                
            } catch (error) {
                console.error('‚ùå Agent generation failed:', error);
                result.className = 'result error';
                result.innerHTML = `<h3>‚ùå Error: ${error.message}</h3>`;
                result.style.display = 'block';
            }
        }
        
        function generateRealAgent(deviceName, platform, orgId) {
            return `#!/usr/bin/env node

/**
 * Real Remote Desktop Agent
 * Device: ${deviceName}
 * Platform: ${platform}
 * Organization: ${orgId}
 * Generated: ${new Date().toISOString()}
 */

const { createClient } = require('@supabase/supabase-js');
const WebSocket = require('ws');
const screenshot = require('screenshot-desktop');
const robot = require('robotjs');
const os = require('os');

class RealRemoteAgent {
    constructor() {
        this.deviceId = this.generateDeviceId();
        this.deviceName = '${deviceName}';
        this.orgId = '${orgId}';
        this.platform = '${platform}';
        this.isConnected = false;
        this.isStreaming = false;
        
        // Supabase configuration
        this.supabaseUrl = 'https://ptrtibzwokjcjjxvjpin.supabase.co';
        this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0cnRpYnp3b2tqY2pqeHZqcGluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM1MTI0NTYsImV4cCI6MjA0OTA4ODQ1Nn0.OwJ04BrJ6gZZ57fSeT-q5Q_mSsVaNia';
        
        console.log('üåç Real Remote Desktop Agent Starting...');
        console.log('üì± Device:', this.deviceName);
        console.log('üè¢ Organization:', this.orgId);
        console.log('üíª Platform:', this.platform);
    }

    generateDeviceId() {
        return 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    }

    async initialize() {
        try {
            console.log('üîß Initializing agent...');
            await this.initializeSupabase();
            await this.registerDevice();
            await this.startWebSocketConnection();
            this.setupScreenCapture();
            this.setupInputControl();
            console.log('‚úÖ Agent initialized successfully');
            this.keepAlive();
        } catch (error) {
            console.error('‚ùå Initialization failed:', error);
            process.exit(1);
        }
    }

    async initializeSupabase() {
        console.log('üì° Connecting to Supabase...');
        this.supabase = createClient(this.supabaseUrl, this.supabaseKey);
        console.log('‚úÖ Supabase connected');
    }

    async registerDevice() {
        try {
            // Initialize Supabase client if not already initialized
            if (!this.supabase) {
                this.supabase = createClient(this.supabaseUrl, this.supabaseKey);
                console.log('‚úÖ Supabase client initialized');
            }
            
            // Generate a unique access key if needed
            const accessKey = require('crypto').randomBytes(16).toString('hex');
            
            // Create device data that matches the schema
            const deviceData = {
                device_id: this.deviceId, // Use our generated device ID
                device_name: this.deviceName,
                device_type: 'desktop',
                operating_system: \`${os.platform()} ${os.release()}\`,
                ip_address: this.getLocalIP(),
                status: 'online',
                last_seen: new Date().toISOString(),
                access_key: accessKey,
                metadata: JSON.stringify({
                    hostname: os.hostname(),
                    platform: os.platform(),
                    release: os.release(),
                    arch: os.arch(),
                    cpus: os.cpus().length,
                    memory: Math.round(os.totalmem() / (1024 * 1024 * 1024)) + 'GB'
                })
            };
            
            console.log('üìù Registering device with data:', JSON.stringify(deviceData, null, 2));
            
            // First, try to update device presence
            const { data: presenceData, error: presenceError } = await this.supabase
                .from('device_presence')
                .upsert({
                    device_id: this.deviceId,
                    status: 'online',
                    last_seen: new Date().toISOString(),
                    connection_info: JSON.stringify({
                        ip: this.getLocalIP(),
                        connection_type: 'supabase_realtime'
                    }),
                    metadata: JSON.stringify({
                        agent_version: '4.1.0',
                        global_edition: true
                    })
                })
                .select();
                
            if (presenceError) {
                console.warn('‚ö†Ô∏è Device presence update failed:', presenceError.message);
                // Continue anyway - might be a permissions issue but we can still try the device registration
            } else {
                console.log('‚úÖ Device presence updated successfully');
            }
            
            // Then register/update the device in remote_devices table
            const { data, error } = await this.supabase
                .from('remote_devices')
                .upsert({
                    device_id: this.deviceId,
                    device_name: this.deviceName,
                    device_type: 'desktop',
                    operating_system: \`${os.platform()} ${os.release()}\`,
                    ip_address: this.getLocalIP(),
                    status: 'online',
                    last_seen: new Date().toISOString(),
                    metadata: deviceData.metadata
                })
                .select();
            
            if (error) {
                console.error('‚ùå Failed to register device:', error.message);
                console.warn('‚ö†Ô∏è Registration response:', error.status || 'Unknown');
                
                // If we get a 401, it might be an authentication issue with the table
                // Let's try a simpler approach with just a GET request to verify connectivity
                const testResponse = await this.supabase
                    .from('remote_devices')
                    .select('count')
                    .limit(1);
                    
                if (testResponse.error) {
                    console.error('‚ùå Test query also failed:', testResponse.error.message);
                } else {
                    console.log('‚úÖ Test query succeeded, but registration failed. Likely a schema mismatch.');
                }
                
                // Continue anyway - the presence table update might be sufficient
                console.log('‚ö†Ô∏è Continuing with Supabase Realtime connection despite registration issues');
            } else {
                console.log('‚úÖ Device registered successfully with Supabase');
            }
            
            return data || { device_id: this.deviceId };
            
        } catch (error) {
            console.error('‚ùå Error in device registration:', error.message);
            console.warn('‚ö†Ô∏è Registration response:', error.status || 'Unknown');
            console.log('‚ö†Ô∏è Continuing with Supabase Realtime connection despite registration issues');
            return { device_id: this.deviceId };
        }
    }

    async startWebSocketConnection() {
        console.log('üîå Connecting to WebSocket...');
        try {
            this.websocket = new WebSocket('ws://localhost:3002');
            
            this.websocket.on('open', () => {
                console.log('‚úÖ WebSocket connected');
                this.websocket.send(JSON.stringify({
                    type: 'device_connect',
                    deviceId: this.deviceId,
                    deviceName: this.deviceName
                }));
            });

            this.websocket.on('message', (data) => {
                const message = JSON.parse(data.toString());
                this.handleMessage(message);
            });

            this.websocket.on('error', (error) => {
                console.error('‚ùå WebSocket error:', error);
            });
        } catch (error) {
            console.log('‚ö†Ô∏è WebSocket server not available');
        }
    }

    handleMessage(message) {
        switch (message.type) {
            case 'start_screen_share':
                this.startScreenShare();
                break;
            case 'stop_screen_share':
                this.stopScreenShare();
                break;
            case 'mouse_move':
                robot.moveMouse(message.data.x, message.data.y);
                break;
            case 'mouse_click':
                robot.mouseClick(message.data.button || 'left');
                break;
            case 'key_press':
                if (message.data.key) {
                    robot.keyTap(message.data.key);
                }
                break;
        }
    }

    setupScreenCapture() {
        console.log('üì∏ Screen capture ready');
    }

    setupInputControl() {
        console.log('üñ±Ô∏è Input control ready');
    }

    startScreenShare() {
        if (this.isStreaming) return;
        console.log('üé• Starting screen share...');
        this.isStreaming = true;
        
        this.streamInterval = setInterval(async () => {
            try {
                const img = await screenshot({ format: 'png' });
                const base64 = img.toString('base64');
                
                if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                    this.websocket.send(JSON.stringify({
                        type: 'screen_frame',
                        data: base64,
                        timestamp: Date.now()
                    }));
                }
            } catch (error) {
                console.error('‚ùå Screen capture error:', error);
            }
        }, 100); // 10 FPS
    }

    stopScreenShare() {
        console.log('‚èπÔ∏è Stopping screen share...');
        this.isStreaming = false;
        if (this.streamInterval) {
            clearInterval(this.streamInterval);
            this.streamInterval = null;
        }
    }

    keepAlive() {
        setInterval(async () => {
            try {
                await this.supabase
                    .from('devices')
                    .update({ last_seen: new Date().toISOString() })
                    .eq('device_id', this.deviceId);
            } catch (error) {
                console.error('‚ùå Heartbeat failed:', error);
            }
        }, 30000);

        process.on('SIGINT', async () => {
            console.log('\nüõë Shutting down...');
            try {
                await this.supabase
                    .from('devices')
                    .update({ status: 'offline' })
                    .eq('device_id', this.deviceId);
            } catch (error) {}
            process.exit(0);
        });

        console.log('üíì Agent running... (Press Ctrl+C to stop)');
    }
}

// Start the agent
if (require.main === module) {
    const agent = new RealRemoteAgent();
    agent.initialize();
}

module.exports = RealRemoteAgent;`;
        }

        function generatePackageJson(deviceName) {
            return `{
  "name": "remote-desktop-agent-${deviceName.toLowerCase().replace(/[^a-z0-9]/g, '-')}",
  "version": "2.0.0",
  "description": "Real Remote Desktop Agent with screen capture and input control",
  "main": "agent.js",
  "scripts": {
    "start": "node agent.js",
    "test": "node -e \"console.log('Agent test OK')\""
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.39.0",
    "ws": "^8.16.0",
    "screenshot-desktop": "^1.15.0",
    "robotjs": "^0.6.0"
  },
  "engines": {
    "node": ">=14.0.0"
  },
  "keywords": ["remote-desktop", "screen-capture", "input-control"],
  "author": "Remote Desktop System",
  "license": "MIT"
}`;
        }

        function generateStartScript(deviceName, platform) {
            if (platform === 'windows') {
                return `@echo off
echo üåç Remote Desktop Agent Setup
echo Device: ${deviceName}
echo.

REM Check Node.js
node --version >nul 2>&1
if %errorlevel% neq 0 (
    echo ‚ùå Node.js not found. Install from: https://nodejs.org/
    pause
    exit /b 1
)

echo ‚úÖ Node.js found
echo üì¶ Installing dependencies...

REM Try different npm paths
where npm >nul 2>&1
if %errorlevel% equ 0 (
    npm install
) else (
    echo ‚ö†Ô∏è npm not in PATH, trying alternative locations...
    if exist "%ProgramFiles%\nodejs\npm.cmd" (
        "%ProgramFiles%\nodejs\npm.cmd" install
    ) else if exist "%ProgramFiles(x86)%\nodejs\npm.cmd" (
        "%ProgramFiles(x86)%\nodejs\npm.cmd" install
    ) else if exist "%APPDATA%\npm\npm.cmd" (
        "%APPDATA%\npm\npm.cmd" install
    ) else (
        echo ‚ùå npm not found. Please install Node.js with npm from: https://nodejs.org/
        echo Or manually run: npm install
        pause
        exit /b 1
    )
)

if %errorlevel% neq 0 (
    echo ‚ùå Dependency installation failed
    echo üí° Try manually running: npm install
    pause
    exit /b 1
)

echo ‚úÖ Dependencies installed
echo üöÄ Starting agent...
node agent.js
pause`;
            } else {
                return `#!/bin/bash
echo "üåç Remote Desktop Agent Setup"
echo "Device: ${deviceName}"
echo ""

# Check Node.js
if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js not found. Install from: https://nodejs.org/"
    exit 1
fi

echo "‚úÖ Node.js found"
echo "üì¶ Installing dependencies..."
npm install

if [ $? -ne 0 ]; then
    echo "‚ùå Dependency installation failed"
    exit 1
fi

echo "‚úÖ Dependencies installed"
echo "üöÄ Starting agent..."
node agent.js`;
            }
        }

        function createAgentDownloads(deviceName, platform, agentContent, packageContent, startScript, result) {
            const cleanName = deviceName.replace(/[^a-zA-Z0-9]/g, '_');
            
            // Create blobs for each file
            const agentBlob = new Blob([agentContent], { type: 'text/javascript' });
            const packageBlob = new Blob([packageContent], { type: 'application/json' });
            const startBlob = new Blob([startScript], { type: 'text/plain' });
            
            // Create URLs
            const agentUrl = window.URL.createObjectURL(agentBlob);
            const packageUrl = window.URL.createObjectURL(packageBlob);
            const startUrl = window.URL.createObjectURL(startBlob);
            
            const startExt = platform === 'windows' ? '.bat' : '.sh';
            
            result.className = 'result success';
            result.innerHTML = `
                <h3>‚úÖ Real Remote Desktop Agent Generated!</h3>
                <p>Your ${platform} agent with <strong>real remote control features</strong> is ready!</p>
                
                <h4>üì• Download Files:</h4>
                <a href="${agentUrl}" download="agent.js" class="download-btn">
                    üìÑ Download agent.js
                </a>
                <a href="${packageUrl}" download="package.json" class="download-btn">
                    üì¶ Download package.json
                </a>
                <a href="${startUrl}" download="start${startExt}" class="download-btn">
                    üöÄ Download start${startExt}
                </a>
                
                <h4>üõ†Ô∏è Setup Instructions:</h4>
                <ol>
                    <li>Download all three files</li>
                    <li>Create a new folder for the agent</li>
                    <li>Put all files in the folder</li>
                    <li>Run the start script (start${startExt})</li>
                    <li>The agent will install dependencies and connect!</li>
                </ol>
                
                <h4>üéØ Features:</h4>
                <ul>
                    <li>‚úÖ Real screen capture</li>
                    <li>‚úÖ Mouse and keyboard control</li>
                    <li>‚úÖ Supabase integration</li>
                    <li>‚úÖ WebSocket communication</li>
                    <li>‚úÖ Device registration</li>
                </ul>
                
                <div class="code-preview">${agentContent.substring(0, 1000)}...</div>
            `;
            result.style.display = 'block';
        }

        // Test that JavaScript is working
        console.log('JavaScript is working properly');
    </script>
</body>
</html>
