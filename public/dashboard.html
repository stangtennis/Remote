<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Remote Desktop Control Center</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333;
        }
        
        .container {
            max-width: 1400px; margin: 0 auto; padding: 20px;
            background: rgba(255,255,255,0.95); border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); min-height: calc(100vh - 40px);
        }
        
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; border-bottom: 1px solid #e5e7eb; margin-bottom: 30px;
        }
        
        .header h1 { font-size: 2rem; color: #4f46e5; }
        
        .stats {
            display: flex; gap: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; padding: 15px 25px; border-radius: 15px; text-align: center;
        }
        
        .stat-value { font-size: 1.5rem; font-weight: 700; }
        .stat-label { font-size: 0.9rem; opacity: 0.9; }
        
        .main-content {
            display: grid; grid-template-columns: 350px 1fr; gap: 30px; height: 600px;
        }
        
        .device-panel {
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow-y: auto;
        }
        
        .device-item {
            background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px;
            border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease;
        }
        
        .device-item:hover { border-color: #4f46e5; transform: translateY(-2px); }
        .device-item.active { border-color: #10b981; background: #ecfdf5; }
        .device-item.online { border-left: 4px solid #10b981; }
        .device-item.offline { border-left: 4px solid #ef4444; }
        
        .device-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        
        .device-name { font-weight: 600; }
        
        .status-badge {
            padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;
        }
        .status-badge.online { background: #dcfce7; color: #166534; }
        .status-badge.offline { background: #fee2e2; color: #991b1b; }
        
        .device-info { font-size: 0.85rem; color: #666; margin-bottom: 10px; }
        
        .device-actions {
            display: flex; gap: 8px;
        }
        
        .action-btn {
            flex: 1; padding: 6px 10px; border: none; border-radius: 6px;
            font-size: 0.8rem; cursor: pointer; font-weight: 600; transition: all 0.2s ease;
        }
        
        .btn-connect { background: #10b981; color: white; }
        .btn-transfer { background: #8b5cf6; color: white; }
        .btn-remove { background: #ef4444; color: white; }
        
        .action-btn:hover { transform: translateY(-1px); }
        .action-btn:disabled { background: #d1d5db; color: #9ca3af; cursor: not-allowed; }
        
        .control-panel {
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column;
        }
        
        .panel-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        
        .panel-title { font-size: 1.3rem; font-weight: 600; }
        
        .quick-actions {
            display: flex; gap: 10px;
        }
        
        .quick-btn {
            padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 600; text-decoration: none; font-size: 0.9rem;
        }
        
        .btn-primary { background: #4f46e5; color: white; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        
        .content-area {
            flex: 1; display: flex; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; color: #666;
        }
        
        .welcome-content h2 { font-size: 1.5rem; margin-bottom: 10px; color: #4f46e5; }
        .welcome-content p { margin-bottom: 20px; }
        
        .feature-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;
        }
        
        .feature-card {
            background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;
        }
        
        .feature-icon { font-size: 1.5rem; margin-bottom: 8px; }
        .feature-title { font-weight: 600; margin-bottom: 5px; }
        .feature-desc { font-size: 0.85rem; color: #666; }
        
        .remote-content {
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px; height: 100%;
        }
        
        .screen-area {
            background: #000; border-radius: 10px; position: relative; color: white;
        }
        
        .screen-controls {
            position: absolute; top: 10px; right: 10px; z-index: 10;
            display: flex; gap: 5px;
        }
        
        .screen-btn {
            background: rgba(0,0,0,0.7); border: none; color: white; padding: 8px;
            border-radius: 6px; cursor: pointer; font-size: 1rem;
        }
        
        .screen-btn:hover { background: rgba(0,0,0,0.9); }
        
        .screen-container {
            width: 100%; height: 100%; display: flex; align-items: center; 
            justify-content: center; position: relative; min-height: 400px;
        }
        
        #remoteScreen {
            border-radius: 8px; cursor: crosshair;
        }
        
        .fullscreen-mode {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important; z-index: 9999 !important;
            background: #000 !important; border-radius: 0 !important;
        }
        
        .controls {
            display: flex; flex-direction: column; gap: 15px;
        }
        
        .control-section h4 {
            margin-bottom: 10px; color: #4f46e5; font-size: 0.9rem;
        }
        
        .control-buttons {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
        }
        
        .control-btn {
            padding: 8px; border: none; border-radius: 6px; cursor: pointer;
            font-size: 0.8rem; font-weight: 600; background: #f3f4f6; color: #374151;
        }
        
        .control-btn:hover { background: #e5e7eb; }
        
        .input-area {
            width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .activity-log {
            background: #1f2937; color: #f9fafb; border-radius: 8px; padding: 15px;
            font-family: monospace; font-size: 0.8rem; height: 150px; overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry { margin-bottom: 3px; }
        .log-time { color: #10b981; margin-right: 8px; }
        
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
            .remote-content { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Remote Desktop Control Center</h1>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="onlineCount">0</div>
                    <div class="stat-label">Online</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="device-panel">
                <h3 style="margin-bottom: 15px; color: #4f46e5;">üì± Connected Devices</h3>
                <div id="deviceList">
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üîç</div>
                        <div>Loading devices...</div>
                    </div>
                </div>
            </div>
            
            <div class="control-panel">
                <div class="panel-header">
                    <div class="panel-title" id="panelTitle">Welcome</div>
                    <div class="quick-actions">
                        <a href="https://stangtennis.github.io/remote-desktop/agent-generator.html" class="quick-btn btn-primary">üì• Download Agent</a>
                        <button class="quick-btn btn-secondary" onclick="refreshDevices()">üîÑ Refresh</button>
                    </div>
                </div>
                
                <div class="content-area" id="contentArea">
                    <div class="welcome-content">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üåç</div>
                        <h2>Welcome to Remote Desktop Control Center</h2>
                        <p>Select a device from the left panel to start remote control</p>
                        
                        <div class="feature-grid">
                            <div class="feature-card">
                                <div class="feature-icon">üñ•Ô∏è</div>
                                <div class="feature-title">Remote Control</div>
                                <div class="feature-desc">Full screen sharing and input control</div>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">üìÅ</div>
                                <div class="feature-title">File Transfer</div>
                                <div class="feature-desc">Secure file uploads and downloads</div>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">üåê</div>
                                <div class="feature-title">Global Access</div>
                                <div class="feature-desc">Connect from anywhere</div>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">üîí</div>
                                <div class="feature-title">Secure</div>
                                <div class="feature-desc">End-to-end encrypted</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="activity-log" id="activityLog"></div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ptrtibzwokjcjjxvjpin.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0cnRpYnp3b2tqY2pqeHZqcGluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MzE1NzEsImV4cCI6MjA3MDAwNzU3MX0.DPNxkQul1-13tqJ89mqYJAx7NSJjabOP4q8c6KgOnWk';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let devices = [];
        let activeDevice = null;
        let activeSession = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            logActivity('Dashboard initialized');
            loadDevices();
            setupRealTimeUpdates();
            setInterval(loadDevices, 30000);
        });
        
        // Load devices
        async function loadDevices() {
            try {
                const { data, error } = await supabaseClient
                    .from('remote_devices')
                    .select('*')
                    .order('last_seen', { ascending: false });
                
                if (error) throw error;
                
                devices = data || [];
                updateStats();
                renderDevices();
                logActivity(`Loaded ${devices.length} devices`);
                
            } catch (err) {
                console.error('Error loading devices:', err);
                logActivity(`Error: ${err.message}`);
            }
        }
        
        // Render devices
        function renderDevices() {
            const deviceList = document.getElementById('deviceList');
            
            if (devices.length === 0) {
                deviceList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üîç</div>
                        <div>No devices found</div>
                        <div style="margin-top: 10px; font-size: 0.9rem;">
                            <a href="https://stangtennis.github.io/remote-desktop/agent-generator.html" style="color: #4f46e5;">Download an agent</a>
                        </div>
                    </div>
                `;
                return;
            }
            
            deviceList.innerHTML = devices.map(device => {
                const isOnline = isDeviceOnline(device);
                const metadata = parseMetadata(device.metadata);
                
                return `
                    <div class="device-item ${isOnline ? 'online' : 'offline'} ${activeDevice?.id === device.id ? 'active' : ''}" 
                         onclick="selectDevice('${device.id}')">
                        <div class="device-header">
                            <div class="device-name">${device.device_name || 'Unknown'}</div>
                            <div class="status-badge ${isOnline ? 'online' : 'offline'}">
                                ${isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
                            </div>
                        </div>
                        <div class="device-info">
                            <div>üíª ${device.operating_system || 'Unknown OS'}</div>
                            <div>üåê ${device.ip_address || 'Unknown IP'}</div>
                            <div>üíæ ${metadata.memory || '?'}GB ‚Ä¢ ${metadata.cpus || '?'} CPUs</div>
                        </div>
                        <div class="device-actions" onclick="event.stopPropagation()">
                            <button class="action-btn btn-connect" onclick="connectDevice('${device.id}')" ${!isOnline ? 'disabled' : ''}>
                                Connect
                            </button>
                            <button class="action-btn btn-transfer" onclick="transferFile('${device.id}')" ${!isOnline ? 'disabled' : ''}>
                                Transfer
                            </button>
                            <button class="action-btn btn-remove" onclick="removeDevice('${device.id}')">
                                Remove
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Utility functions
        function parseMetadata(metadata) {
            try {
                return typeof metadata === 'string' ? JSON.parse(metadata) : (metadata || {});
            } catch (e) {
                return {};
            }
        }
        
        function isDeviceOnline(device) {
            if (!device.last_seen) return false;
            const lastSeen = new Date(device.last_seen);
            const now = new Date();
            return (now - lastSeen) < 2 * 60 * 1000;
        }
        
        function updateStats() {
            const online = devices.filter(d => isDeviceOnline(d)).length;
            document.getElementById('onlineCount').textContent = online;
            document.getElementById('totalCount').textContent = devices.length;
        }
        
        // Device actions
        function selectDevice(device) {
            activeDevice = device;
            logActivity(`üì± Selected device: ${device.device_name} (ID: ${device.id})`);
            updateDeviceActions();
            updateRemoteControlPanel();
            updateFileTransferPanel();
        }
        
        function connectDevice(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (device) {
                selectDevice(device);
                startSession();
            }
        }
        
        function transferFile(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (device) {
                selectDevice(device);
                showFileTransfer();
            }
        }
        
        async function removeDevice(deviceId) {
            if (!confirm('Remove this device?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('remote_devices')
                    .delete()
                    .eq('id', deviceId);
                
                if (error) throw error;
                
                logActivity('Device removed');
                loadDevices();
                
            } catch (err) {
                logActivity(`Error removing device: ${err.message}`);
            }
        }
        
        // UI functions
        function showRemoteControl() {
            if (!activeDevice) return;
            
            document.getElementById('panelTitle').textContent = `Remote Control - ${activeDevice.device_name}`;
            document.getElementById('contentArea').innerHTML = `
                <div class="remote-content">
                    <div class="screen-area" id="screenArea">
                        <div class="screen-controls">
                            <button class="screen-btn" onclick="toggleFullscreen()" title="Full Screen">üî≥</button>
                            <button class="screen-btn" onclick="fitToWindow()" title="Fit to Window">üìê</button>
                            <button class="screen-btn" onclick="actualSize()" title="Actual Size">üîç</button>
                        </div>
                        <div class="screen-container" id="screenContainer">
                            <canvas id="remoteScreen" style="max-width: 100%; max-height: 100%; background: #000;"></canvas>
                            <div id="screenPlaceholder" style="text-align: center; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div style="font-size: 3rem; margin-bottom: 10px;">üì∫</div>
                                <div>Remote screen will appear here</div>
                                <div style="margin-top: 10px; font-size: 0.9rem;">Click "Start Session" to begin</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <div class="control-section">
                            <h4>üéÆ Session Control</h4>
                            <div class="control-buttons">
                                <button class="control-btn" onclick="startSession()">üéØ Start</button>
                                <button class="control-btn" onclick="endSession()">üõë End</button>
                                <button class="control-btn" onclick="captureScreen()">üì∏ Capture</button>
                                <button class="control-btn" onclick="sendCtrlAltDel()">‚å®Ô∏è Ctrl+Alt+Del</button>
                            </div>
                        </div>
                        
                        <div class="control-section">
                            <h4>üìÅ File Transfer</h4>
                            <div class="control-buttons">
                                <button class="control-btn" onclick="showFileTransfer()">üì§ Send</button>
                                <button class="control-btn" onclick="requestFile()">üì• Request</button>
                            </div>
                        </div>
                        
                        <div class="control-section">
                            <h4>üéÆ Remote Input</h4>
                            <textarea class="input-area" placeholder="Type text..." id="textInput"></textarea>
                            <button class="control-btn" onclick="sendText()" style="width: 100%; margin-bottom: 8px;">Send Text</button>
                            <div class="control-buttons">
                                <input type="number" placeholder="X" id="mouseX" class="input-area" style="margin: 0;">
                                <input type="number" placeholder="Y" id="mouseY" class="input-area" style="margin: 0;">
                                <button class="control-btn" onclick="clickMouse('left')">Click</button>
                                <button class="control-btn" onclick="clickMouse('right')">Right Click</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showFileTransfer() {
            if (!activeDevice) {
                alert('Please select a device first');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await uploadFile(file);
                }
            };
            input.click();
        }
        
        // Session management
        async function startSession() {
            if (!activeDevice) return;
            
            try {
                const sessionId = 'session_' + Date.now();
                activeSession = { id: sessionId, deviceId: activeDevice.id };
                
                // Set up screen frame listener for this device
                setupScreenFrameListener();
                
                await sendCommand({
                    type: 'start_session',
                    sessionId: sessionId,
                    controller: { id: 'dashboard', name: 'Dashboard' }
                });
                
                logActivity('Session started');
                initializeScreen();
                
            } catch (error) {
                logActivity(`Session error: ${error.message}`);
            }
        }
        
        function setupScreenFrameListener() {
            if (!activeDevice) return;
            
            const deviceChannel = `device-${activeDevice.id}`;
            supabaseClient
                .channel(deviceChannel)
                .on('broadcast', { event: 'screen_frame' }, (payload) => {
                    if (payload.payload && payload.payload.frameData) {
                        displayScreenFrame(payload.payload.frameData);
                    }
                })
                .subscribe();
                
            logActivity(`Screen frame listener set up for ${activeDevice.device_name}`);
        }
        
        async function endSession() {
            if (!activeSession) return;
            
            try {
                await sendCommand({
                    type: 'end_session',
                    sessionId: activeSession.id
                });
                
                activeSession = null;
                logActivity('Session ended');
                
            } catch (error) {
                logActivity(`Session error: ${error.message}`);
            }
        }
        
        // Command functions
        async function sendCommand(command) {
            if (!activeDevice) return;
            
            try {
                const channelName = `device-${activeDevice.id}`;
                
                await supabaseClient
                    .channel(channelName)
                    .send({
                        type: 'broadcast',
                        event: 'command',
                        payload: { ...command, timestamp: Date.now() }
                    });
                    
            } catch (error) {
                console.error('Command error:', error);
                throw error;
            }
        }
        
        async function captureScreen() {
            await sendCommand({ type: 'capture_screen' });
            logActivity('Screen capture requested');
        }
        
        async function sendCtrlAltDel() {
            await sendCommand({ type: 'ctrl_alt_del' });
            logActivity('Ctrl+Alt+Del sent');
        }
        
        async function sendText() {
            const text = document.getElementById('textInput').value;
            if (text) {
                await sendCommand({ type: 'send_text', text: text });
                document.getElementById('textInput').value = '';
                logActivity(`Text sent: ${text}`);
            }
        }
        
        async function clickMouse(button) {
            const x = parseInt(document.getElementById('mouseX').value) || 0;
            const y = parseInt(document.getElementById('mouseY').value) || 0;
            
            await sendCommand({ type: 'mouse_click', x: x, y: y, button: button });
            logActivity(`Mouse ${button} click at (${x}, ${y})`);
        }
        
        // File transfer
        async function uploadFile(file) {
            try {
                logActivity(`Starting file transfer: ${file.name}`);
                
                // Validate device is selected and has valid ID
                if (!activeDevice) {
                    throw new Error('No device selected');
                }
                
                if (!activeDevice.id) {
                    throw new Error('Selected device has no ID');
                }
                
                logActivity(`Target device: ${activeDevice.device_name} (ID: ${activeDevice.id})`);
                
                const response = await fetch('https://ptrtibzwokjcjjxvjpin.supabase.co/functions/v1/file-transfer/api/initiate-transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        sourceDeviceId: 'dashboard',
                        targetDeviceId: activeDevice.id,
                        fileName: file.name,
                        fileSize: file.size,
                        fileType: file.type || 'application/octet-stream',
                        transferType: 'upload'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    logActivity(`‚ùå Transfer initiation failed: ${errorData.error || response.statusText}`);
                    logActivity(`Response status: ${response.status}`);
                    logActivity(`Device ID sent: ${activeDevice.id}`);
                    throw new Error(`Transfer failed: ${errorData.error || response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    logActivity(`Transfer initiated: ${result.sessionId}`);
                    await uploadFileChunks(result.sessionId, file);
                } else {
                    throw new Error(result.error || 'Transfer failed');
                }
                
            } catch (error) {
                logActivity(`Transfer error: ${error.message}`);
                alert(`File transfer failed: ${error.message}`);
            }
        }
        
        async function uploadFileChunks(sessionId, file) {
            const chunkSize = 1024 * 1024; // 1MB
            const totalChunks = Math.ceil(file.size / chunkSize);
            
            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);
                
                const chunkBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(chunk);
                });
                
                const response = await fetch('https://ptrtibzwokjcjjxvjpin.supabase.co/functions/v1/file-transfer/api/upload-chunk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        chunkIndex: i,
                        chunkData: chunkBase64,
                        isLastChunk: i === totalChunks - 1
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(`Chunk ${i} failed: ${result.error}`);
                }
                
                const progress = Math.round(((i + 1) / totalChunks) * 100);
                logActivity(`Upload progress: ${progress}%`);
            }
            
            logActivity('File transfer completed successfully');
            alert('File transfer completed!');
        }
        
        // Screen display functions
        let isFullscreen = false;
        let screenCanvas = null;
        let screenContext = null;
        
        function initializeScreen() {
            screenCanvas = document.getElementById('remoteScreen');
            if (screenCanvas) {
                screenContext = screenCanvas.getContext('2d');
                setupScreenEventListeners();
            }
        }
        
        function setupScreenEventListeners() {
            if (!screenCanvas) return;
            
            // Mouse events for remote control
            screenCanvas.addEventListener('click', (e) => {
                const rect = screenCanvas.getBoundingClientRect();
                const scaleX = screenCanvas.width / rect.width;
                const scaleY = screenCanvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                
                sendCommand({ type: 'mouse_click', x: Math.round(x), y: Math.round(y), button: 'left' });
                logActivity(`Mouse click at (${Math.round(x)}, ${Math.round(y)})`);
            });
            
            // Keyboard events
            screenCanvas.addEventListener('keydown', (e) => {
                e.preventDefault();
                sendCommand({ type: 'key_press', key: e.key, code: e.code });
                logActivity(`Key pressed: ${e.key}`);
            });
            
            screenCanvas.tabIndex = 0; // Make canvas focusable
        }
        
        function displayScreenFrame(frameData) {
            if (!screenCanvas || !screenContext) {
                initializeScreen();
                if (!screenCanvas) return;
            }
            
            const img = new Image();
            img.onload = function() {
                screenCanvas.width = img.width;
                screenCanvas.height = img.height;
                screenContext.drawImage(img, 0, 0);
                
                // Hide placeholder when first frame is displayed
                const placeholder = document.getElementById('screenPlaceholder');
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
            };
            img.src = 'data:image/png;base64,' + frameData;
        }
        
        function toggleFullscreen() {
            const screenArea = document.getElementById('screenArea');
            if (!screenArea) return;
            
            if (!isFullscreen) {
                screenArea.classList.add('fullscreen-mode');
                isFullscreen = true;
                logActivity('Entered fullscreen mode');
            } else {
                screenArea.classList.remove('fullscreen-mode');
                isFullscreen = false;
                logActivity('Exited fullscreen mode');
            }
            
            // Escape key to exit fullscreen
            if (isFullscreen) {
                document.addEventListener('keydown', handleEscapeKey);
            } else {
                document.removeEventListener('keydown', handleEscapeKey);
            }
        }
        
        function handleEscapeKey(e) {
            if (e.key === 'Escape' && isFullscreen) {
                toggleFullscreen();
            }
        }
        
        function fitToWindow() {
            if (screenCanvas) {
                screenCanvas.style.maxWidth = '100%';
                screenCanvas.style.maxHeight = '100%';
                screenCanvas.style.width = 'auto';
                screenCanvas.style.height = 'auto';
                logActivity('Screen fitted to window');
            }
        }
        
        function actualSize() {
            if (screenCanvas) {
                screenCanvas.style.maxWidth = 'none';
                screenCanvas.style.maxHeight = 'none';
                screenCanvas.style.width = screenCanvas.width + 'px';
                screenCanvas.style.height = screenCanvas.height + 'px';
                logActivity('Screen set to actual size');
            }
        }

        // Real-time updates
        function setupRealTimeUpdates() {
            supabaseClient
                .channel('device-updates')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'remote_devices' }, 
                    () => loadDevices()
                )
                .subscribe();
                
            // Listen for screen frames from active device
            if (activeDevice) {
                const deviceChannel = `device-${activeDevice.id}`;
                supabaseClient
                    .channel(deviceChannel)
                    .on('broadcast', { event: 'screen_frame' }, (payload) => {
                        if (payload.payload && payload.payload.frameData) {
                            displayScreenFrame(payload.payload.frameData);
                        }
                    })
                    .subscribe();
            }
        }
        
        // Utility functions
        function refreshDevices() {
            loadDevices();
            logActivity('Devices refreshed');
        }
        
        function logActivity(message) {
            const log = document.getElementById('activityLog');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            
            // Keep only last 50 entries
            while (log.children.length > 50) {
                log.removeChild(log.firstChild);
            }
        }
    </script>
</body>
</html>
