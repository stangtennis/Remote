<!DOCTYPE html>
<html>
<head>
    <title>Test Dashboard</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Test Dashboard</h1>
    <button onclick="testConnection()">Test Connection</button>
    <button onclick="startSession()">Start Session</button>
    <div id="log"></div>
    <canvas id="screen" width="800" height="600" style="border: 1px solid black;"></canvas>

    <script>
        console.log('Test dashboard loading...');
        
        const SUPABASE_URL = 'https://ptrtibzwokjcjjxvjpin.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0cnRpYnp3b2tqY2pqeHZqcGluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MzE1NzEsImV4cCI6MjA3MDAwNzU3MX0.DPNxkQul1-13tqJ89mqYJAx7NSJjabOP4q8c6KgOnWk';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase client created');
        
        let deviceId = '4238907b-59ee-e8fc-8ae1-b24bcb287527'; // Your device ID
        
        function log(message) {
            console.log(message);
            document.getElementById('log').innerHTML += '<div>' + message + '</div>';
        }
        
        function testConnection() {
            log('Testing connection...');
            console.log('Test button clicked');
        }
        
        async function startSession() {
            log('Starting session...');
            console.log('Start session clicked');
            
            const sessionId = 'test_session_' + Date.now();
            const channel = supabase.channel(`device-${deviceId}`);
            
            // Listen for screen frames
            channel.on('broadcast', { event: 'screen_frame' }, (payload) => {
                console.log('Received screen frame:', payload);
                log('Screen frame received!');
                
                if (payload.payload) {
                    displayScreen(payload.payload);
                }
            }).subscribe((status) => {
                console.log('Channel status:', status);
                log('Channel status: ' + status);
            });
            
            // Send start session command
            await channel.send({
                type: 'broadcast',
                event: 'command',
                payload: {
                    type: 'start_session',
                    sessionId: sessionId,
                    timestamp: Date.now(),
                    controller: { id: 'test', name: 'Test' }
                }
            });
            
            log('Session started: ' + sessionId);
        }
        
        function displayScreen(data) {
            console.log('Displaying screen data:', data);
            log('Displaying screen...');
            
            const canvas = document.getElementById('screen');
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                log('Screen displayed!');
            };
            
            // Try different data formats
            if (typeof data === 'string') {
                img.src = 'data:image/svg+xml;base64,' + data;
            } else if (data.data) {
                img.src = 'data:image/svg+xml;base64,' + data.data;
            }
        }
        
        console.log('Test dashboard ready');
        log('Test dashboard ready');
    </script>
</body>
</html>
