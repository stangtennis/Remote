<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Remote Desktop Control Center - Full Dashboard</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1600px; margin: 0 auto; background: white;
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); padding: 40px;
        }
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 40px; flex-wrap: wrap; gap: 20px;
        }
        .header h1 { color: #333; font-size: 2.5rem; }
        .header-stats {
            display: flex; gap: 20px; flex-wrap: wrap;
        }
        .stat-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; padding: 15px 25px; border-radius: 15px; text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; }
        .stat-label { font-size: 0.9rem; opacity: 0.9; }
        
        .success-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; padding: 15px; border-radius: 10px; margin-bottom: 30px;
            text-align: center; font-weight: 600;
        }
        
        .controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; flex-wrap: wrap; gap: 20px;
        }
        .search-box {
            flex: 1; min-width: 300px; position: relative;
        }
        .search-box input {
            width: 100%; padding: 15px 50px 15px 20px; border: 2px solid #e5e7eb;
            border-radius: 15px; font-size: 1rem; transition: all 0.3s ease;
        }
        .search-box input:focus {
            outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .search-icon {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            color: #9ca3af; font-size: 1.2rem;
        }
        
        .filter-buttons {
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        .filter-btn {
            padding: 10px 20px; border: 2px solid #e5e7eb; background: white;
            border-radius: 10px; cursor: pointer; transition: all 0.3s ease;
            font-weight: 600;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; border-color: #4f46e5;
        }
        .filter-btn:hover {
            border-color: #4f46e5; transform: translateY(-2px);
        }
        
        .devices-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px; margin-bottom: 30px;
        }
        .device-card {
            background: #f8f9fa; border-radius: 20px; padding: 25px;
            border: 2px solid #e5e7eb; transition: all 0.3s ease; position: relative;
        }
        .device-card:hover {
            transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border-color: #4f46e5;
        }
        .device-card.online { border-left: 6px solid #10b981; }
        .device-card.offline { border-left: 6px solid #ef4444; }
        
        .device-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
        }
        .device-name { font-size: 1.2rem; font-weight: 700; color: #333; }
        .status-badge {
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
        }
        .status-badge.online { background: #dcfce7; color: #166534; }
        .status-badge.offline { background: #fee2e2; color: #991b1b; }
        
        .device-info {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;
        }
        .info-item {
            display: flex; flex-direction: column;
        }
        .info-label { font-size: 0.8rem; color: #6b7280; font-weight: 600; }
        .info-value { font-size: 0.9rem; color: #333; font-weight: 500; }
        
        .device-actions {
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        .action-btn {
            flex: 1; min-width: 100px; padding: 12px; border: none; border-radius: 10px;
            cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .action-btn:hover {
            transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .action-btn:disabled {
            background: #d1d5db; color: #9ca3af; cursor: not-allowed;
            transform: none;
        }
        
        .empty-state {
            text-align: center; padding: 60px 20px; color: #6b7280;
        }
        .empty-state h3 { font-size: 1.5rem; margin-bottom: 10px; }
        .empty-state p { font-size: 1.1rem; }
        
        .loading {
            text-align: center; padding: 40px; color: #6b7280;
        }
        .spinner {
            display: inline-block; width: 40px; height: 40px; border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .back-link {
            display: inline-block; margin-top: 20px; color: #4f46e5;
            text-decoration: none; font-weight: 600;
        }
        .back-link:hover { text-decoration: underline; }
        
        .quick-actions {
            display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;
        }
        .quick-action-btn {
            padding: 15px 25px; border: none; border-radius: 15px; cursor: pointer;
            font-weight: 600; transition: all 0.3s ease; text-decoration: none;
            display: inline-block;
        }
        .quick-action-btn:hover {
            transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .btn-connect { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-transfer { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .btn-info { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; }
        .btn-test { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn-download { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; }
        .btn-refresh { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .btn-settings { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="success-banner">
            üéâ Full Remote Desktop Control Center - Agent Connected and Ready!
        </div>
        
        <div class="header">
            <h1>üåç Remote Desktop Control Center</h1>
            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-value" id="onlineCount">0</div>
                    <div class="stat-label">Online</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total Devices</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="sessionCount">0</div>
                    <div class="stat-label">Active Sessions</div>
                </div>
            </div>
        </div>
        
        <div class="quick-actions">
            <a href="agent-generator.html" class="quick-action-btn btn-download">üì• Download Agent</a>
            <button class="quick-action-btn btn-refresh" onclick="loadDevices()">üîÑ Refresh Devices</button>
            <button class="quick-action-btn btn-settings" onclick="showSettings()">‚öôÔ∏è Settings</button>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search devices by name, IP, or platform...">
                <div class="search-icon">üîç</div>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">All Devices</button>
                <button class="filter-btn" data-filter="online">Online Only</button>
                <button class="filter-btn" data-filter="offline">Offline Only</button>
                <button class="filter-btn" data-filter="windows">Windows</button>
                <button class="filter-btn" data-filter="mac">Mac</button>
            </div>
        </div>

        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>Loading devices from Supabase...</p>
        </div>

        <div id="devicesGrid" class="devices-grid" style="display: none;"></div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>üîç No Devices Found</h3>
            <p>No remote desktop agents are currently connected to your Supabase backend.</p>
            <p style="margin-top: 10px;">
                <a href="agent-generator.html" style="color: #4f46e5; text-decoration: none; font-weight: 600;">
                    üì• Download an agent
                </a> to get started!
            </p>
        </div>

        <a href="dashboard.html" class="back-link">‚Üê Back to Main Dashboard</a>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ptrtibzwokjcjjxvjpin.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0cnRpYnp3b2tqY2pqeHZqcGluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MzE1NzEsImV4cCI6MjA3MDAwNzU3MX0.DPNxkQul1-13tqJ89mqYJAx7NSJjabOP4q8c6KgOnWk';
        
        // Initialize Supabase client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global variables
        let devices = [];
        let activeChannels = {};
        let activeDeviceId = null;
        let searchTerm = '';
        let currentFilter = 'all';
        let activeSessions = 0;
        
        // DOM elements
        const loadingState = document.getElementById('loadingState');
        const devicesGrid = document.getElementById('devicesGrid');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const onlineCount = document.getElementById('onlineCount');
        const totalCount = document.getElementById('totalCount');
        const sessionCount = document.getElementById('sessionCount');
        
        // Load devices from Supabase
        async function loadDevices() {
            try {
                console.log('Loading devices from Supabase...');
                
                const { data, error } = await supabaseClient
                    .from('remote_devices')
                    .select('*')
                    .order('last_seen', { ascending: false });
                
                if (error) {
                    console.error('Error loading devices:', error);
                    showEmptyState();
                    return;
                }
                
                devices = data || [];
                console.log(`Loaded ${devices.length} devices`);
                
                updateStats();
                renderDevices();
                
            } catch (err) {
                console.error('Connection error:', err);
                showEmptyState();
            }
        }
        
        // Check if device is online (last seen within 2 minutes)
        function isDeviceOnline(device) {
            if (!device.last_seen) return false;
            const lastSeen = new Date(device.last_seen);
            const now = new Date();
            return (now - lastSeen) < 2 * 60 * 1000; // 2 minutes
        }
        
        // Update statistics
        function updateStats() {
            const online = devices.filter(d => isDeviceOnline(d)).length;
            onlineCount.textContent = online;
            totalCount.textContent = devices.length;
            sessionCount.textContent = activeSessions;
        }
        
        // Create device card HTML
        function createDeviceCard(device) {
            const isOnline = isDeviceOnline(device);
            const lastSeen = device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never';
            
            return `
                <div class="device-card ${isOnline ? 'online' : 'offline'}">
                    <div class="device-header">
                        <div class="device-name">${device.device_name || 'Unknown Device'}</div>
                        <div class="status-badge ${isOnline ? 'online' : 'offline'}">
                            ${isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
                        </div>
                    </div>
                    
                    <div class="device-info">
                        <div class="info-item">
                            <div class="info-label">IP Address</div>
                            <div class="info-value">${device.ip_address || 'Unknown'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Platform</div>
                            <div class="info-value">${device.operating_system || device.platform || 'Unknown'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Last Seen</div>
                            <div class="info-value">${lastSeen}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Device ID</div>
                            <div class="info-value">${device.id}</div>
                        </div>
                    </div>
                    
                    <div class="device-actions">
                        <button class="action-btn btn-connect" onclick="connectToDevice('${device.id}')" ${!isOnline ? 'disabled' : ''}>
                        ${isOnline ? 'Connect' : 'Offline'}
                    </button>
                    <button class="action-btn btn-transfer" onclick="showFileTransfer('${device.id}')" ${!isOnline ? 'disabled' : ''}>
                        ${isOnline ? 'Transfer' : 'Offline'}
                    </button>
                    <button class="action-btn btn-info" onclick="showDeviceInfo('${device.id}')">
                        Details
                    </button>
                    <button class="action-btn btn-test" onclick="testConnection('${device.id}')" ${!isOnline ? 'disabled' : ''}>
                        Test
                    </button>
                        <button class="action-btn btn-danger" data-action="remove" data-device-id="${device.id}">
                            Remove
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Render devices grid
        function renderDevices() {
            loadingState.style.display = 'none';
            
            const filteredDevices = devices.filter(device => {
                // Apply search filter
                if (searchTerm) {
                    const searchLower = searchTerm.toLowerCase();
                    const matchesSearch = 
                        device.device_name?.toLowerCase().includes(searchLower) ||
                        device.ip_address?.toLowerCase().includes(searchLower) ||
                        device.operating_system?.toLowerCase().includes(searchLower) ||
                        device.platform?.toLowerCase().includes(searchLower);
                    if (!matchesSearch) return false;
                }
                
                // Apply status filter
                if (currentFilter === 'online') return isDeviceOnline(device);
                if (currentFilter === 'offline') return !isDeviceOnline(device);
                if (currentFilter === 'windows') return device.operating_system?.toLowerCase().includes('win') || device.platform?.toLowerCase().includes('win');
                if (currentFilter === 'mac') return device.operating_system?.toLowerCase().includes('mac') || device.platform?.toLowerCase().includes('mac');
                
                return true;
            });
            
            if (filteredDevices.length === 0) {
                showEmptyState();
                return;
            }
            
            devicesGrid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            devicesGrid.innerHTML = filteredDevices.map(device => createDeviceCard(device)).join('');
            
            // Add event listeners to action buttons
            addActionListeners();
        }
        
        // Show empty state
        function showEmptyState() {
            loadingState.style.display = 'none';
            devicesGrid.style.display = 'none';
            emptyState.style.display = 'block';
        }
        
        // Add event listeners to action buttons
        function addActionListeners() {
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', handleDeviceAction);
            });
        }
        
        // Handle device actions
        function handleDeviceAction(e) {
            const action = e.target.dataset.action;
            const deviceId = e.target.dataset.deviceId;
            const device = devices.find(d => d.id === deviceId);
            
            switch (action) {
                case 'connect':
                    connectToDevice(device);
                    break;
                case 'info':
                    showDeviceInfo(device);
                    break;
                case 'test':
                    testDevice(device);
                    break;
                case 'remove':
                    removeDevice(device);
                    break;
            }
        }
        
        // Connect to device using Supabase Realtime
        async function connectToDevice(device) {
            console.log('Connecting to device:', device.device_name);
            
            // Set as active device
            activeDeviceId = device.id;
            activeSessions++;
            updateStats();
            
            try {
                // Create a unique session ID
                const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
                
                // Subscribe to device's response channel if not already subscribed
                if (!activeChannels[device.id]) {
                    const channelName = `device-${device.id}`;
                    
                    activeChannels[device.id] = supabaseClient
                        .channel(channelName)
                        .on('broadcast', { event: 'response' }, (payload) => {
                            console.log('üì• Device response:', payload);
                            handleDeviceResponse(payload.payload);
                        })
                        .subscribe();
                    
                    console.log(`üì° Subscribed to device channel: ${channelName}`);
                }
                
                // Send start session command
                await sendDeviceCommand(device.id, {
                    type: 'start_session',
                    sessionId: sessionId,
                    controllerInfo: {
                        id: 'admin_' + Math.random().toString(36).substring(2, 9),
                        name: 'Admin Dashboard',
                        timestamp: Date.now()
                    }
                });
                
                // Open remote control window
                window.open(`remote-control.html?deviceId=${device.id}&sessionId=${sessionId}`, '_blank');
                
            } catch (error) {
                console.error('Error connecting to device:', error);
                alert(`Failed to connect to ${device.device_name}. Error: ${error.message}`);
                activeSessions = Math.max(0, activeSessions - 1);
                updateStats();
            }
        }
        
        // Test device connection
        async function testDevice(device) {
            console.log('Testing device:', device.device_name);
            
            try {
                await sendDeviceCommand(device.id, {
                    type: 'ping',
                    timestamp: Date.now()
                });
                
                alert(`Test ping sent to ${device.device_name}. Check console for response.`);
                
            } catch (error) {
                console.error('Error testing device:', error);
                alert(`Failed to test ${device.device_name}. Error: ${error.message}`);
            }
        }
        
        // Show device info
        function showDeviceInfo(device) {
            const info = `
Device Information:
‚Ä¢ Name: ${device.device_name || 'Unknown'}
‚Ä¢ IP Address: ${device.ip_address || 'Unknown'}
‚Ä¢ Operating System: ${device.operating_system || 'Unknown'}
‚Ä¢ Platform: ${device.platform || 'Unknown'}
‚Ä¢ Device Type: ${device.device_type || 'Unknown'}
‚Ä¢ Status: ${device.status || 'Unknown'}
‚Ä¢ Last Seen: ${device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never'}
‚Ä¢ Device ID: ${device.id}
‚Ä¢ Metadata: ${device.metadata ? JSON.stringify(device.metadata, null, 2) : 'None'}
            `;
            alert(info);
        }
        
        // Remove device
        async function removeDevice(device) {
            if (!confirm(`Are you sure you want to remove "${device.device_name}"?`)) return;
            
            try {
                const { error } = await supabaseClient
                    .from('remote_devices')
                    .delete()
                    .eq('id', device.id);
                
                if (error) {
                    console.error('‚ùå Error removing device:', error);
                    alert('Failed to remove device. Please try again.');
                    return;
                }
                
                console.log('‚úÖ Device removed successfully');
                loadDevices(); // Reload devices
                
            } catch (err) {
                console.error('‚ùå Error removing device:', err);
                alert('Failed to remove device. Please try again.');
            }
        }
        
        // Send command to device via Supabase Realtime
        async function sendDeviceCommand(deviceId, command) {
            try {
                const channelName = `device-${deviceId}`;
                
                // Add metadata to command
                const commandPayload = {
                    ...command,
                    sender: 'admin_dashboard',
                    timestamp: Date.now()
                };
                
                // Send command via Supabase Realtime broadcast
                await supabaseClient
                    .channel(channelName)
                    .send({
                        type: 'broadcast',
                        event: 'command',
                        payload: commandPayload
                    });
                    
                console.log('üì§ Command sent to device:', command.type);
                return true;
            } catch (error) {
                console.error('‚ùå Error sending command:', error);
                throw error;
            }
        }
        
        // Handle device responses from Supabase Realtime
        function handleDeviceResponse(response) {
            console.log('üì• Device response:', response.type);
            
            switch (response.type) {
                case 'screen_frame':
                    // Would handle screen frame updates in remote control window
                    console.log('üì∫ Received screen frame from device');
                    break;
                    
                case 'heartbeat':
                    console.log('üíì Received heartbeat from device:', response.deviceName);
                    // Update device status without full reload
                    updateDeviceStatus(response.deviceId, 'online');
                    break;
                    
                case 'pong':
                    console.log('üèì Received pong from device - connection test successful');
                    alert('Device connection test successful! üéâ');
                    break;
                    
                case 'system_info':
                    console.log('‚ÑπÔ∏è Received system info from device:', response.data);
                    break;
                    
                default:
                    console.log('üì© Received response:', response);
            }
        }
        
        // Update device status without full reload
        function updateDeviceStatus(deviceId, status) {
            // Find device in current list
            const deviceIndex = devices.findIndex(d => d.id === deviceId);
            if (deviceIndex >= 0) {
                devices[deviceIndex].status = status;
                devices[deviceIndex].last_seen = new Date().toISOString();
                
                // Update UI for this device
                const deviceCard = document.querySelector(`[data-device-id="${deviceId}"]`);
                if (deviceCard) {
                    const statusBadge = deviceCard.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.textContent = status === 'online' ? 'üü¢ Online' : 'üî¥ Offline';
                        statusBadge.className = `status-badge ${status}`;
                    }
                    
                    // Update card border
                    deviceCard.className = `device-card ${status}`;
                }
                
                // Update stats
                updateStats();
            }
        }
        
        // Real-time updates for database changes
        function setupRealTimeUpdates() {
            const subscription = supabaseClient
                .channel('device-updates')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'remote_devices' }, 
                    (payload) => {
                        console.log('üîÑ Real-time database update received:', payload);
                        loadDevices(); // Reload devices on database change
                    }
                )
                .subscribe();
            
            console.log('üì° Real-time database updates enabled');
            
            // Also subscribe to global commands channel
            supabaseClient
                .channel('admin-dashboard')
                .on('broadcast', { event: 'notification' }, (payload) => {
                    console.log('üì¢ Admin notification received:', payload);
                    // Could show notifications to admin
                })
                .subscribe();
        }
        
        // Show file transfer dialog
        function showFileTransfer(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) {
                alert('‚ùå Device not found');
                return;
            }

            const transferOptions = `
File Transfer Options for ${device.device_name}:

1. üì§ Send File to Device
2. üì• Request File from Device
3. üìã View Transfer History
4. üîÑ Active Transfers

Choose an option:
1 - Send File
2 - Request File
3 - History
4 - Active
            `;

            const choice = prompt(transferOptions);
            
            switch(choice) {
                case '1':
                    initiateFileSend(deviceId);
                    break;
                case '2':
                    requestFileFromDevice(deviceId);
                    break;
                case '3':
                    showTransferHistory(deviceId);
                    break;
                case '4':
                    showActiveTransfers(deviceId);
                    break;
                default:
                    if (choice !== null) {
                        alert('‚ùå Invalid option selected');
                    }
            }
        }

        // Initiate file send to device
        async function initiateFileSend(targetDeviceId) {
            try {
                // Create file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.style.display = 'none';
                
                fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    console.log(`üìÅ Initiating file transfer: ${file.name} (${file.size} bytes)`);
                    
                    // Show progress dialog
                    const progressDialog = showTransferProgress(file.name, 'Uploading');
                    
                    try {
                        // Call file transfer Edge Function
                        const response = await fetch('https://ptrtibzwokjcjjxvjpin.supabase.co/functions/v1/file-transfer/api/initiate-transfer', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            },
                            body: JSON.stringify({
                                sourceDeviceId: 'dashboard', // Dashboard as source
                                targetDeviceId: targetDeviceId,
                                fileName: file.name,
                                fileSize: file.size,
                                fileType: file.type || 'application/octet-stream',
                                transferType: 'upload'
                            })
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            console.log(`‚úÖ Transfer session created: ${result.sessionId}`);
                            await uploadFileInChunks(result.sessionId, file, progressDialog);
                        } else {
                            throw new Error(result.error || 'Failed to initiate transfer');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå File transfer failed:', error);
                        alert(`‚ùå File transfer failed: ${error.message}`);
                        progressDialog.remove();
                    }
                };
                
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
                
            } catch (error) {
                console.error('‚ùå File send initiation failed:', error);
                alert(`‚ùå Failed to start file transfer: ${error.message}`);
            }
        }

        // Upload file in chunks
        async function uploadFileInChunks(sessionId, file, progressDialog) {
            const chunkSize = 1024 * 1024; // 1MB chunks
            const totalChunks = Math.ceil(file.size / chunkSize);
            let uploadedChunks = 0;

            try {
                for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
                    const start = chunkIndex * chunkSize;
                    const end = Math.min(start + chunkSize, file.size);
                    const chunk = file.slice(start, end);
                    
                    // Convert chunk to base64
                    const chunkBase64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(chunk);
                    });

                    const response = await fetch('https://ptrtibzwokjcjjxvjpin.supabase.co/functions/v1/file-transfer/api/upload-chunk', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({
                            sessionId: sessionId,
                            chunkIndex: chunkIndex.toString(),
                            totalChunks: totalChunks.toString(),
                            chunk: chunkBase64
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        uploadedChunks++;
                        const progress = Math.round((uploadedChunks / totalChunks) * 100);
                        updateTransferProgress(progressDialog, progress);
                        console.log(`üì§ Uploaded chunk ${uploadedChunks}/${totalChunks} (${progress}%)`);
                    } else {
                        throw new Error(`Failed to upload chunk ${chunkIndex}: ${result.error}`);
                    }
                }

                // Transfer completed
                updateTransferProgress(progressDialog, 100, 'Completed');
                setTimeout(() => progressDialog.remove(), 3000);
                alert(`‚úÖ File transfer completed successfully!`);
                
            } catch (error) {
                console.error('‚ùå Chunk upload failed:', error);
                updateTransferProgress(progressDialog, -1, 'Failed');
                setTimeout(() => progressDialog.remove(), 3000);
                throw error;
            }
        }

        // Show transfer progress dialog
        function showTransferProgress(fileName, status) {
            const progressDialog = document.createElement('div');
            progressDialog.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                background: white; border-radius: 15px; padding: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2); min-width: 300px;
                border-left: 4px solid #8b5cf6;
            `;
            
            progressDialog.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <div style="font-size: 1.5rem; margin-right: 10px;">üìÅ</div>
                    <div>
                        <div style="font-weight: 600; color: #333;">${fileName}</div>
                        <div style="font-size: 0.9rem; color: #666;" class="transfer-status">${status}</div>
                    </div>
                </div>
                <div style="background: #f3f4f6; border-radius: 10px; height: 8px; overflow: hidden;">
                    <div class="progress-bar" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div class="progress-text" style="text-align: center; margin-top: 10px; font-size: 0.9rem; color: #666;">0%</div>
            `;
            
            document.body.appendChild(progressDialog);
            return progressDialog;
        }

        // Update transfer progress
        function updateTransferProgress(progressDialog, progress, status = null) {
            const progressBar = progressDialog.querySelector('.progress-bar');
            const progressText = progressDialog.querySelector('.progress-text');
            const statusElement = progressDialog.querySelector('.transfer-status');
            
            if (progress >= 0) {
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${progress}%`;
            }
            
            if (status) {
                statusElement.textContent = status;
                if (status === 'Completed') {
                    statusElement.style.color = '#10b981';
                } else if (status === 'Failed') {
                    statusElement.style.color = '#ef4444';
                    progressBar.style.background = '#ef4444';
                }
            }
        }

        // Request file from device
        function requestFileFromDevice(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;

            const fileName = prompt(`üì• Request file from ${device.device_name}:\n\nEnter the file path on the remote device:`);
            if (!fileName) return;

            alert(`üîÑ File request sent to ${device.device_name}\n\nFile: ${fileName}\n\nThe device will be notified to send this file.`);
            console.log(`üì• File request sent to device ${deviceId}: ${fileName}`);
        }

        // Show transfer history
        async function showTransferHistory(deviceId) {
            try {
                const response = await fetch(`https://ptrtibzwokjcjjxvjpin.supabase.co/functions/v1/file-transfer/api/list-transfers?deviceId=${deviceId}`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                const transfers = await response.json();
                
                if (transfers && transfers.length > 0) {
                    const historyText = transfers.map(t => 
                        `üìÅ ${t.fileName} (${Math.round(t.fileSize / 1024)}KB) - ${t.status} - ${new Date(t.createdAt).toLocaleString()}`
                    ).join('\n');
                    
                    alert(`üìã Transfer History:\n\n${historyText}`);
                } else {
                    alert('üìã No transfer history found for this device.');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load transfer history:', error);
                alert('‚ùå Failed to load transfer history');
            }
        }

        // Show active transfers
        function showActiveTransfers(deviceId) {
            alert('üîÑ Active Transfers:\n\nNo active transfers at the moment.\n\nThis feature will show real-time transfer progress for ongoing file operations.');
        }

        // Show settings dialog
        function showSettings() {
            alert('Settings panel coming soon! üõ†Ô∏è\n\nCurrent features:\n‚Ä¢ Real-time device monitoring\n‚Ä¢ Remote control sessions\n‚Ä¢ Device management\n‚Ä¢ Connection testing\n‚Ä¢ File transfer system');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDevices();
            setupRealTimeUpdates();
            addActionListeners();
            
            // Refresh devices every 30 seconds
            setInterval(loadDevices, 30000);
            
            // Search functionality
            searchInput.addEventListener('input', (e) => {
                searchTerm = e.target.value;
                renderDevices();
            });
            
            // Filter functionality
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Update active button
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Update filter
                    currentFilter = e.target.dataset.filter;
                    renderDevices();
                });
            });
            
            // Clean up channels when leaving page
            window.addEventListener('beforeunload', () => {
                Object.values(activeChannels).forEach(channel => {
                    if (channel && channel.unsubscribe) {
                        channel.unsubscribe();
                    }
                });
            });
        });
        
        console.log('‚úÖ Full Remote Desktop Control Center initialized with Supabase Realtime integration');
    </script>
</body>
</html>
