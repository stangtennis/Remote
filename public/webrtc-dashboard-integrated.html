<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Remote Desktop Dashboard</title>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
            height: calc(100vh - 200px);
        }
        
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        
        .viewer-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .section {
            margin-bottom: 24px;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .device-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .device-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .device-item:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            transform: translateY(-2px);
        }
        
        .device-item.selected {
            background: #2196f3;
            color: white;
            border-color: #1976d2;
        }
        
        .device-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .device-info {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .device-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .device-status.online {
            background: #4caf50;
        }
        
        .device-status.offline {
            background: #f44336;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .btn {
            background: linear-gradient(45deg, #2196f3, #21cbf3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
        }
        
        .btn-success:hover {
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #ff5722);
        }
        
        .btn-danger:hover {
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #ffc107);
        }
        
        .btn-warning:hover {
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }
        
        .video-container {
            flex: 1;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }
        
        .video-overlay {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .connection-status.disconnected {
            background: #ffebee;
            color: #c62828;
        }
        
        .connection-status.connecting {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .connection-status.connected {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.disconnected {
            background: #c62828;
        }
        
        .status-indicator.connecting {
            background: #ef6c00;
        }
        
        .status-indicator.connected {
            background: #2e7d32;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .stats h4 {
            margin-bottom: 12px;
            color: #2c3e50;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 16px;
        }
        
        .log-entry {
            margin-bottom: 4px;
            word-wrap: break-word;
        }
        
        .log-entry.error {
            color: #ff6b6b;
        }
        
        .log-entry.warning {
            color: #ffd93d;
        }
        
        .log-entry.success {
            color: #6bcf7f;
        }
        
        .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #7f8c8d;
            text-align: center;
        }
        
        .placeholder i {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .placeholder h3 {
            margin-bottom: 8px;
            color: #7f8c8d;
        }
        
        .special-commands {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.85rem;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sidebar {
                order: 2;
            }
            
            .viewer-area {
                order: 1;
                min-height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1><i class="fas fa-desktop"></i> WebRTC Remote Desktop</h1>
            <p>Professional remote desktop solution with real-time screen sharing and input control</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="section">
                    <h3><i class="fas fa-server"></i> Devices</h3>
                    <div class="device-list" id="deviceList">
                        <div class="placeholder">
                            <i class="fas fa-search"></i>
                            <p>Loading devices...</p>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-cogs"></i> Controls</h3>
                    <div class="controls">
                        <button id="connectBtn" class="btn btn-success" disabled>
                            <i class="fas fa-play"></i> Connect
                        </button>
                        <button id="disconnectBtn" class="btn btn-danger" disabled>
                            <i class="fas fa-stop"></i> Disconnect
                        </button>
                        <button id="refreshBtn" class="btn">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="controls">
                        <button id="inputToggleBtn" class="btn btn-warning" disabled>
                            <i class="fas fa-mouse"></i> Enable Input
                        </button>
                        <button id="fullscreenBtn" class="btn" disabled>
                            <i class="fas fa-expand"></i> Fullscreen
                        </button>
                        <button id="screenshotBtn" class="btn" disabled>
                            <i class="fas fa-camera"></i> Screenshot
                        </button>
                    </div>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-keyboard"></i> Special Commands</h3>
                    <div class="special-commands">
                        <button id="ctrlAltDelBtn" class="btn btn-sm" disabled>Ctrl+Alt+Del</button>
                        <button id="altTabBtn" class="btn btn-sm" disabled>Alt+Tab</button>
                        <button id="winKeyBtn" class="btn btn-sm" disabled>Win Key</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-chart-line"></i> Statistics</h3>
                    <div class="stats" id="statsContainer">
                        <div class="stat-item">
                            <span>Connection:</span>
                            <span id="connectionStat">Disconnected</span>
                        </div>
                        <div class="stat-item">
                            <span>Latency:</span>
                            <span id="latencyStat">-</span>
                        </div>
                        <div class="stat-item">
                            <span>Resolution:</span>
                            <span id="resolutionStat">-</span>
                        </div>
                        <div class="stat-item">
                            <span>Bandwidth:</span>
                            <span id="bandwidthStat">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="viewer-area">
                <div class="connection-status disconnected" id="connectionStatus">
                    <div class="status-indicator disconnected"></div>
                    <span>Disconnected - Select a device to connect</span>
                </div>
                
                <div class="video-container">
                    <video id="remoteVideo" autoplay muted playsinline style="display: none;"></video>
                    <div class="video-overlay" id="videoOverlay" style="display: none;">
                        <span id="overlayText">Connected</span>
                    </div>
                    
                    <div class="placeholder" id="videoPlaceholder">
                        <i class="fas fa-desktop"></i>
                        <h3>No Connection</h3>
                        <p>Select a device from the sidebar and click Connect to start remote desktop session</p>
                    </div>
                </div>
                
                <div id="fileTransferContainer"></div>
                
                <div class="log-container" id="logContainer">
                    <div class="log-entry success">‚úÖ Dashboard initialized successfully</div>
                    <div class="log-entry">üîÑ Loading Supabase integration...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load our modular JavaScript files -->
    <script src="js/supabase-integration.js"></script>
    <script src="js/webrtc-connection.js"></script>
    <script src="js/session-control.js"></script>
    <script src="js/file-transfer.js"></script>

    <script>
        // Main Dashboard Application
        class WebRTCDashboard {
            constructor() {
                this.selectedDevice = null;
                this.currentSession = null;
                this.connectionStats = {};
                this.logEntries = [];
                
                this.initialize();
            }
            
            async initialize() {
                try {
                    this.log('üöÄ Initializing WebRTC Dashboard...', 'success');
                    
                    // Initialize modules
                    await this.initializeModules();
                    
                    // Set up event handlers
                    this.setupEventHandlers();
                    
                    // Load initial data
                    await this.loadDevices();
                    
                    // Start periodic updates
                    this.startPeriodicUpdates();
                    
                    this.log('‚úÖ Dashboard initialization complete', 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Dashboard initialization failed: ${error.message}`, 'error');
                    console.error('Dashboard initialization error:', error);
                }
            }
            
            async initializeModules() {
                this.log('üîß Initializing modules...');
                
                // Initialize Supabase
                await SupabaseIntegration.initializeSupabase();
                this.log('‚úÖ Supabase integration ready');
                
                // Set up WebRTC handlers
                WebRTCConnection.setConnectionStateHandler(this.handleConnectionStateChange.bind(this));
                WebRTCConnection.setRemoteStreamHandler(this.handleRemoteStream.bind(this));
                WebRTCConnection.setDataChannelMessageHandler(this.handleDataChannelMessage.bind(this));
                WebRTCConnection.setErrorHandler(this.handleError.bind(this));
                this.log('‚úÖ WebRTC connection handlers set');
                
                // Set up session control handlers
                SessionControl.setInputCommandHandler(this.handleInputCommand.bind(this));
                SessionControl.setSessionStateHandler(this.handleSessionStateChange.bind(this));
                this.log('‚úÖ Session control handlers set');
                
                // Initialize file transfer
                FileTransfer.initializeFileTransfer('dashboard');
                FileTransfer.setFileUploadHandler(this.handleFileUpload.bind(this));
                FileTransfer.setFileDownloadHandler(this.handleFileDownload.bind(this));
                this.log('‚úÖ File transfer ready');
            }
            
            setupEventHandlers() {
                this.log('üîß Setting up UI event handlers...');
                
                // Device selection
                document.getElementById('deviceList').addEventListener('click', (e) => {
                    const deviceItem = e.target.closest('.device-item');
                    if (deviceItem) {
                        this.selectDevice(deviceItem.dataset.deviceId);
                    }
                });
                
                // Control buttons
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnect());
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadDevices());
                
                document.getElementById('inputToggleBtn').addEventListener('click', () => this.toggleInput());
                document.getElementById('fullscreenBtn').addEventListener('click', () => this.toggleFullscreen());
                document.getElementById('screenshotBtn').addEventListener('click', () => this.takeScreenshot());
                
                // Special commands
                document.getElementById('ctrlAltDelBtn').addEventListener('click', () => SessionControl.sendCtrlAltDel());
                document.getElementById('altTabBtn').addEventListener('click', () => SessionControl.sendAltTab());
                document.getElementById('winKeyBtn').addEventListener('click', () => SessionControl.sendWinKey());
                
                this.log('‚úÖ UI event handlers ready');
            }
            
            async loadDevices() {
                try {
                    this.log('üì± Loading devices...');
                    
                    const devices = await SupabaseIntegration.loadDevices();
                    this.renderDevices(devices);
                    
                    this.log(`‚úÖ Loaded ${devices.length} devices`);
                    
                } catch (error) {
                    this.log(`‚ùå Failed to load devices: ${error.message}`, 'error');
                }
            }
            
            renderDevices(devices) {
                const deviceList = document.getElementById('deviceList');
                
                if (devices.length === 0) {
                    deviceList.innerHTML = `
                        <div class="placeholder">
                            <i class="fas fa-server"></i>
                            <p>No devices found</p>
                        </div>
                    `;
                    return;
                }
                
                deviceList.innerHTML = devices.map(device => `
                    <div class="device-item" data-device-id="${device.device_id}">
                        <div class="device-name">
                            <span class="device-status ${device.is_online ? 'online' : 'offline'}"></span>
                            ${device.device_name || device.device_id}
                        </div>
                        <div class="device-info">
                            ${device.platform || 'Unknown'} ‚Ä¢ ${device.is_online ? 'Online' : 'Offline'}
                        </div>
                    </div>
                `).join('');
            }
            
            selectDevice(deviceId) {
                // Update UI selection
                document.querySelectorAll('.device-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                const selectedItem = document.querySelector(`[data-device-id="${deviceId}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                    this.selectedDevice = deviceId;
                    
                    // Enable connect button
                    document.getElementById('connectBtn').disabled = false;
                    
                    this.log(`üì± Selected device: ${deviceId}`);
                }
            }
            
            async connect() {
                if (!this.selectedDevice) {
                    this.log('‚ùå No device selected', 'error');
                    return;
                }
                
                try {
                    this.log(`üîó Connecting to device: ${this.selectedDevice}`);
                    
                    // Start session
                    const session = await SupabaseIntegration.startSession(this.selectedDevice, 'remote_control');
                    this.currentSession = session;
                    
                    // Initialize WebRTC connection
                    const roomId = `device_${this.selectedDevice}`;
                    await WebRTCConnection.initializeWebRTC(roomId, false);
                    
                    // Initialize session control
                    SessionControl.initializeSessionControl(this.selectedDevice, session.session_id);
                    
                    // Update UI
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    
                    this.log('‚úÖ Connection initiated');
                    
                } catch (error) {
                    this.log(`‚ùå Connection failed: ${error.message}`, 'error');
                }
            }
            
            async disconnect() {
                try {
                    this.log('üîå Disconnecting...');
                    
                    // End session
                    if (this.currentSession) {
                        await SupabaseIntegration.endSession(this.currentSession.session_id);
                        SessionControl.endSession();
                    }
                    
                    // Disconnect WebRTC
                    WebRTCConnection.disconnect();
                    
                    // Reset UI
                    this.resetUI();
                    
                    this.log('‚úÖ Disconnected');
                    
                } catch (error) {
                    this.log(`‚ùå Disconnect error: ${error.message}`, 'error');
                }
            }
            
            resetUI() {
                // Hide video
                document.getElementById('remoteVideo').style.display = 'none';
                document.getElementById('videoOverlay').style.display = 'none';
                document.getElementById('videoPlaceholder').style.display = 'flex';
                
                // Reset buttons
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('inputToggleBtn').disabled = true;
                document.getElementById('fullscreenBtn').disabled = true;
                document.getElementById('screenshotBtn').disabled = true;
                
                // Disable special commands
                document.querySelectorAll('.special-commands button').forEach(btn => {
                    btn.disabled = true;
                });
                
                // Reset connection status
                this.updateConnectionStatus('disconnected', 'Disconnected');
                
                this.currentSession = null;
            }
            
            toggleInput() {
                SessionControl.toggleInput();
                const isEnabled = SessionControl.isInputEnabled();
                
                const btn = document.getElementById('inputToggleBtn');
                btn.innerHTML = isEnabled ? 
                    '<i class="fas fa-mouse"></i> Disable Input' : 
                    '<i class="fas fa-mouse"></i> Enable Input';
                
                this.log(`üñ±Ô∏è Input ${isEnabled ? 'enabled' : 'disabled'}`);
            }
            
            toggleFullscreen() {
                const videoContainer = document.querySelector('.video-container');
                
                if (!document.fullscreenElement) {
                    videoContainer.requestFullscreen();
                    this.log('üñ•Ô∏è Entered fullscreen');
                } else {
                    document.exitFullscreen();
                    this.log('üñ•Ô∏è Exited fullscreen');
                }
            }
            
            takeScreenshot() {
                SessionControl.sendScreenshot();
                this.log('üì∏ Screenshot requested');
            }
            
            // Event handlers
            handleConnectionStateChange(state) {
                this.log(`üì° Connection state: ${state}`);
                
                let statusText = state.charAt(0).toUpperCase() + state.slice(1);
                this.updateConnectionStatus(state, statusText);
                
                if (state === 'connected') {
                    // Enable controls
                    document.getElementById('inputToggleBtn').disabled = false;
                    document.getElementById('fullscreenBtn').disabled = false;
                    document.getElementById('screenshotBtn').disabled = false;
                    
                    // Enable special commands
                    document.querySelectorAll('.special-commands button').forEach(btn => {
                        btn.disabled = false;
                    });
                }
            }
            
            handleRemoteStream(stream) {
                this.log('üì∫ Remote stream received');
                
                const video = document.getElementById('remoteVideo');
                video.srcObject = stream;
                video.style.display = 'block';
                
                document.getElementById('videoPlaceholder').style.display = 'none';
                document.getElementById('videoOverlay').style.display = 'block';
                
                // Update resolution stats
                video.onloadedmetadata = () => {
                    document.getElementById('resolutionStat').textContent = 
                        `${video.videoWidth}x${video.videoHeight}`;
                };
            }
            
            handleDataChannelMessage(message) {
                this.log(`üì® Data channel message: ${message.type}`);
            }
            
            handleInputCommand(command) {
                // Send input command via WebRTC data channel
                WebRTCConnection.sendInputCommand(command);
            }
            
            handleSessionStateChange(state, sessionId, deviceId) {
                this.log(`üéÆ Session state: ${state}`);
            }
            
            handleError(error) {
                this.log(`‚ùå Error: ${error.message}`, 'error');
            }
            
            async handleFileUpload(file, onProgress) {
                return await SupabaseIntegration.uploadFile(this.selectedDevice, file, onProgress);
            }
            
            async handleFileDownload(fileName, onProgress) {
                return await SupabaseIntegration.downloadFile(this.selectedDevice, fileName);
            }
            
            updateConnectionStatus(state, text) {
                const statusElement = document.getElementById('connectionStatus');
                const indicator = statusElement.querySelector('.status-indicator');
                
                statusElement.className = `connection-status ${state}`;
                indicator.className = `status-indicator ${state}`;
                statusElement.querySelector('span').textContent = text;
                
                document.getElementById('connectionStat').textContent = text;
            }
            
            startPeriodicUpdates() {
                // Update stats every 5 seconds
                setInterval(async () => {
                    if (WebRTCConnection.isConnected()) {
                        const stats = await WebRTCConnection.getConnectionStats();
                        if (stats) {
                            this.updateStats(stats);
                        }
                    }
                }, 5000);
                
                // Refresh devices every 30 seconds
                setInterval(() => {
                    this.loadDevices();
                }, 30000);
            }
            
            updateStats(stats) {
                if (stats.video) {
                    const bandwidth = Math.round(stats.video.bytesReceived / 1024);
                    document.getElementById('bandwidthStat').textContent = `${bandwidth} KB/s`;
                }
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}`;
                
                console.log(logEntry);
                
                const logContainer = document.getElementById('logContainer');
                const logElement = document.createElement('div');
                logElement.className = `log-entry ${type}`;
                logElement.textContent = logEntry;
                
                logContainer.appendChild(logElement);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Keep only last 100 entries
                const entries = logContainer.querySelectorAll('.log-entry');
                if (entries.length > 100) {
                    entries[0].remove();
                }
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new WebRTCDashboard();
        });
    </script>
</body>
</html>
