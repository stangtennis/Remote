<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñ•Ô∏è Device Manager - Supabase Hosted</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1400px; margin: 0 auto; background: white;
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); padding: 40px;
        }
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 40px; flex-wrap: wrap; gap: 20px;
        }
        .header h1 { color: #333; font-size: 2.5rem; }
        .header-stats {
            display: flex; gap: 20px; flex-wrap: wrap;
        }
        .stat-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; padding: 15px 25px; border-radius: 15px; text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; }
        .stat-label { font-size: 0.9rem; opacity: 0.9; }
        
        .success-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; padding: 15px; border-radius: 10px; margin-bottom: 30px;
            text-align: center; font-weight: 600;
        }
        
        .controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; flex-wrap: wrap; gap: 20px;
        }
        .search-box {
            flex: 1; min-width: 300px; position: relative;
        }
        .search-box input {
            width: 100%; padding: 15px 50px 15px 20px; border: 2px solid #e5e7eb;
            border-radius: 15px; font-size: 1rem; transition: all 0.3s ease;
        }
        .search-box input:focus {
            outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .search-icon {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            color: #9ca3af; font-size: 1.2rem;
        }
        
        .filter-buttons {
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        .filter-btn {
            padding: 10px 20px; border: 2px solid #e5e7eb; background: white;
            border-radius: 10px; cursor: pointer; transition: all 0.3s ease;
            font-weight: 600;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; border-color: #4f46e5;
        }
        .filter-btn:hover {
            border-color: #4f46e5; transform: translateY(-2px);
        }
        
        .devices-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px; margin-bottom: 30px;
        }
        .device-card {
            background: #f8f9fa; border-radius: 20px; padding: 25px;
            border: 2px solid #e5e7eb; transition: all 0.3s ease; position: relative;
        }
        .device-card:hover {
            transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border-color: #4f46e5;
        }
        .device-card.online { border-left: 6px solid #10b981; }
        .device-card.offline { border-left: 6px solid #ef4444; }
        
        .device-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
        }
        .device-name { font-size: 1.2rem; font-weight: 700; color: #333; }
        .status-badge {
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
        }
        .status-badge.online { background: #dcfce7; color: #166534; }
        .status-badge.offline { background: #fee2e2; color: #991b1b; }
        
        .device-info {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
        }
        .info-item {
            display: flex; flex-direction: column;
        }
        .info-label { font-size: 0.8rem; color: #6b7280; font-weight: 600; }
        .info-value { font-size: 0.9rem; color: #333; font-weight: 500; }
        
        .device-actions {
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        .action-btn {
            flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 10px;
            cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .action-btn:hover { transform: translateY(-2px); }
        .action-btn:disabled {
            background: #d1d5db; color: #9ca3af; cursor: not-allowed;
            transform: none;
        }
        
        .empty-state {
            text-align: center; padding: 60px 20px; color: #6b7280;
        }
        .empty-state h3 { font-size: 1.5rem; margin-bottom: 10px; }
        .empty-state p { font-size: 1.1rem; }
        
        .back-link {
            display: inline-block; margin-top: 20px; color: #4f46e5;
            text-decoration: none; font-weight: 600;
        }
        .back-link:hover { text-decoration: underline; }
        
        .loading {
            text-align: center; padding: 40px; color: #6b7280;
        }
        .spinner {
            display: inline-block; width: 40px; height: 40px; border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="success-banner">
            üéâ Now Hosted on Supabase Storage! Real-time Device Management Dashboard
        </div>
        
        <div class="header">
            <h1>üñ•Ô∏è Device Manager</h1>
            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-value" id="onlineCount">0</div>
                    <div class="stat-label">Online</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total Devices</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search devices by name, IP, or platform...">
                <div class="search-icon">üîç</div>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">All Devices</button>
                <button class="filter-btn" data-filter="online">Online Only</button>
                <button class="filter-btn" data-filter="offline">Offline Only</button>
                <button class="filter-btn" data-filter="windows">Windows</button>
                <button class="filter-btn" data-filter="mac">Mac</button>
            </div>
        </div>

        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>Loading devices from Supabase...</p>
        </div>

        <div id="devicesGrid" class="devices-grid" style="display: none;"></div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>üîç No Devices Found</h3>
            <p>No remote desktop agents are currently connected to your Supabase backend.</p>
            <p style="margin-top: 10px;">
                <a href="agent-generator.html" style="color: #4f46e5; text-decoration: none; font-weight: 600;">
                    üì• Download an agent
                </a> to get started!
            </p>
        </div>

        <a href="dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        console.log('Supabase-hosted Device Manager loaded');
        
        // Initialize Supabase client
        const SUPABASE_URL = 'https://ptrtibzwokjcjjxvjpin.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0cnRpYnp3b2tqY2pqeHZqcGluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjI5NzI4NjQsImV4cCI6MjAzODU0ODg2NH0.YEUuAhBnrCJaOFjXlzOIkqvgFuAoNjvXJWaVNFBNOPE';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        console.log('Supabase client initialized');
        
        // Variables
        let devices = [];
        let searchTerm = '';
        let currentFilter = 'all';
        let activeChannels = {}; // Track active Realtime channels
        let activeDeviceId = null; // Currently selected device for control
        
        // DOM Elements
        const loadingState = document.getElementById('loadingState');
        const devicesGrid = document.getElementById('devicesGrid');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const onlineCount = document.getElementById('onlineCount');
        const totalCount = document.getElementById('totalCount');
        
        // Load devices from Supabase
        async function loadDevices() {
            try {
                console.log('Loading devices from Supabase...');
                
                const { data, error } = await supabaseClient
                    .from('remote_devices')
                    .select('*')
                    .order('last_seen', { ascending: false });
                
                if (error) {
                    console.error('Error loading devices:', error);
                    showEmptyState();
                    return;
                }
                
                devices = data || [];
                console.log(`Loaded ${devices.length} devices`);
                
                updateStats();
                renderDevices();
                
            } catch (err) {
                console.error('Connection error:', err);
                showEmptyState();
            }
        }
        
        // Update statistics
        function updateStats() {
            const online = devices.filter(d => isDeviceOnline(d)).length;
            onlineCount.textContent = online;
            totalCount.textContent = devices.length;
        }
        
        // Check if device is online (last seen within 2 minutes)
        function isDeviceOnline(device) {
            if (!device.last_seen) return false;
            const lastSeen = new Date(device.last_seen);
            const now = new Date();
            return (now - lastSeen) < 2 * 60 * 1000; // 2 minutes
        }
        
        // Render devices grid
        function renderDevices() {
            loadingState.style.display = 'none';
            
            const filteredDevices = devices.filter(device => {
                // Apply search filter
                if (searchTerm) {
                    const searchLower = searchTerm.toLowerCase();
                    const matchesSearch = 
                        device.device_name?.toLowerCase().includes(searchLower) ||
                        device.ip_address?.toLowerCase().includes(searchLower) ||
                        device.platform?.toLowerCase().includes(searchLower);
                    if (!matchesSearch) return false;
                }
                
                // Apply status filter
                if (currentFilter === 'online') return isDeviceOnline(device);
                if (currentFilter === 'offline') return !isDeviceOnline(device);
                if (currentFilter === 'windows') return device.platform?.toLowerCase().includes('win');
                if (currentFilter === 'mac') return device.platform?.toLowerCase().includes('mac');
                
                return true;
            });
            
            if (filteredDevices.length === 0) {
                showEmptyState();
                return;
            }
            
            devicesGrid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            devicesGrid.innerHTML = filteredDevices.map(device => createDeviceCard(device)).join('');
            
            // Add event listeners to action buttons
            addActionListeners();
        }
        
        // Create device card HTML
        function createDeviceCard(device) {
            const isOnline = isDeviceOnline(device);
            const lastSeen = device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never';
            
            return `
                <div class="device-card ${isOnline ? 'online' : 'offline'}">
                    <div class="device-header">
                        <div class="device-name">${device.device_name || 'Unknown Device'}</div>
                        <div class="status-badge ${isOnline ? 'online' : 'offline'}">
                            ${isOnline ? 'Online' : 'Offline'}
                        </div>
                    </div>
                    
                    <div class="device-info">
                        <div class="info-item">
                            <div class="info-label">IP Address</div>
                            <div class="info-value">${device.ip_address || 'Unknown'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Platform</div>
                            <div class="info-value">${device.platform || 'Unknown'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Last Seen</div>
                            <div class="info-value">${lastSeen}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Agent Version</div>
                            <div class="info-value">${device.agent_version || 'Unknown'}</div>
                        </div>
                    </div>
                    
                    <div class="device-actions">
                        <button class="action-btn btn-primary" data-action="connect" data-device-id="${device.id}" ${!isOnline ? 'disabled' : ''}>
                            Connect
                        </button>
                        <button class="action-btn btn-secondary" data-action="info" data-device-id="${device.id}">
                            Info
                        </button>
                        <button class="action-btn btn-danger" data-action="remove" data-device-id="${device.id}">
                            Remove
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Add event listeners to action buttons
        function addActionListeners() {
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', handleDeviceAction);
            });
        }
        
        // Handle device actions
        function handleDeviceAction(e) {
            const action = e.target.dataset.action;
            const deviceId = e.target.dataset.deviceId;
            const device = devices.find(d => d.id === deviceId);
            
            switch (action) {
                case 'connect':
                    connectToDevice(device);
                    break;
                case 'info':
                    showDeviceInfo(device);
                    break;
                case 'remove':
                    removeDevice(device);
                    break;
            }
        }
        
        // Connect to device using Supabase Realtime
        async function connectToDevice(device) {
            console.log('Connecting to device:', device.device_name);
            
            // Set as active device
            activeDeviceId = device.id;
            
            try {
                // Create a unique session ID
                const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
                
                // Subscribe to device's response channel if not already subscribed
                if (!activeChannels[device.id]) {
                    const channelName = `device-${device.id}`;
                    
                    activeChannels[device.id] = supabaseClient
                        .channel(channelName)
                        .on('broadcast', { event: 'response' }, (payload) => {
                            console.log('Received response from device:', payload);
                            handleDeviceResponse(payload.payload);
                        })
                        .subscribe((status) => {
                            console.log(`Channel ${channelName} status:`, status);
                        });
                        
                    console.log(`Subscribed to device channel: ${channelName}`);
                }
                
                // Send connect command via Supabase Realtime
                await sendDeviceCommand(device.id, {
                    type: 'start_session',
                    sessionId: sessionId,
                    controllerInfo: {
                        id: 'admin_' + Math.random().toString(36).substring(2, 9),
                        name: 'Admin Dashboard',
                        timestamp: Date.now()
                    }
                });
                
                // Open remote control window
                window.open(`remote-control.html?deviceId=${device.id}&sessionId=${sessionId}`, '_blank');
                
            } catch (error) {
                console.error('Error connecting to device:', error);
                alert(`Failed to connect to ${device.device_name}. Error: ${error.message}`);
            }
        }
        
        // Show device info
        function showDeviceInfo(device) {
            const info = `
Device Information:
‚Ä¢ Name: ${device.device_name || 'Unknown'}
‚Ä¢ IP Address: ${device.ip_address || 'Unknown'}
‚Ä¢ Platform: ${device.platform || 'Unknown'}
‚Ä¢ Agent Version: ${device.agent_version || 'Unknown'}
‚Ä¢ Last Seen: ${device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never'}
‚Ä¢ Device ID: ${device.id}
            `;
            alert(info);
        }
        
        // Remove device
        async function removeDevice(device) {
            if (!confirm(`Are you sure you want to remove "${device.device_name}"?`)) return;
            
            try {
                const { error } = await supabaseClient
                    .from('remote_devices')
                    .delete()
                    .eq('id', device.id);
                
                if (error) {
                    console.error('‚ùå Error removing device:', error);
                    alert('Failed to remove device. Please try again.');
                    return;
                }
                
                console.log('‚úÖ Device removed successfully');
                loadDevices(); // Reload devices
                
            } catch (err) {
                console.error('‚ùå Error removing device:', err);
                alert('Failed to remove device. Please try again.');
            }
        }
        
        // Show empty state
        function showEmptyState() {
            loadingState.style.display = 'none';
            devicesGrid.style.display = 'none';
            emptyState.style.display = 'block';
        }
        
        // Search functionality
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            renderDevices();
        });
        
        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Update active button
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                // Update filter
                currentFilter = e.target.dataset.filter;
                renderDevices();
            });
        });
        
        // Handle device responses from Supabase Realtime
        function handleDeviceResponse(response) {
            console.log('üì• Device response:', response.type);
            
            switch (response.type) {
                case 'screen_frame':
                    // Would handle screen frame updates in remote control window
                    console.log('üì∫ Received screen frame from device');
                    break;
                    
                case 'heartbeat':
                    console.log('üíì Received heartbeat from device:', response.deviceName);
                    // Update device status without full reload
                    updateDeviceStatus(response.deviceId, 'online');
                    break;
                    
                case 'system_info':
                    console.log('‚ÑπÔ∏è Received system info from device:', response.data);
                    break;
                    
                default:
                    console.log('üì© Received response:', response);
            }
        }
        
        // Send command to device via Supabase Realtime
        async function sendDeviceCommand(deviceId, command) {
            try {
                const channelName = `device-${deviceId}`;
                
                // Add metadata to command
                const commandPayload = {
                    ...command,
                    sender: 'admin_dashboard',
                    timestamp: Date.now()
                };
                
                // Send command via Supabase Realtime broadcast
                await supabaseClient
                    .channel(channelName)
                    .send({
                        type: 'broadcast',
                        event: 'command',
                        payload: commandPayload
                    });
                    
                console.log('üì§ Command sent to device:', command.type);
                return true;
            } catch (error) {
                console.error('‚ùå Error sending command:', error);
                throw error;
            }
        }
        
        // Update device status without full reload
        function updateDeviceStatus(deviceId, status) {
            // Find device in current list
            const deviceIndex = devices.findIndex(d => d.id === deviceId);
            if (deviceIndex >= 0) {
                devices[deviceIndex].status = status;
                devices[deviceIndex].last_seen = new Date().toISOString();
                
                // Update UI for this device
                const deviceCard = document.querySelector(`[data-device-id="${deviceId}"]`);
                if (deviceCard) {
                    const statusBadge = deviceCard.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.textContent = status === 'online' ? 'Online' : 'Offline';
                        statusBadge.className = `status-badge ${status}`;
                    }
                    
                    // Update card border
                    deviceCard.className = `device-card ${status}`;
                }
                
                // Update stats
                updateStats();
            }
        }
        
        // Real-time updates for database changes
        function setupRealTimeUpdates() {
            const subscription = supabaseClient
                .channel('device-updates')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'remote_devices' }, 
                    (payload) => {
                        console.log('üîÑ Real-time database update received:', payload);
                        loadDevices(); // Reload devices on database change
                    }
                )
                .subscribe();
            
            console.log('üì° Real-time database updates enabled');
            
            // Also subscribe to global commands channel
            supabaseClient
                .channel('admin-dashboard')
                .on('broadcast', { event: 'notification' }, (payload) => {
                    console.log('üì¢ Admin notification received:', payload);
                    // Could show notifications to admin
                })
                .subscribe();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDevices();
            setupRealTimeUpdates();
            addActionListeners();
            
            // Refresh devices every 30 seconds
            setInterval(loadDevices, 30000);
            
            // Clean up channels when leaving page
            window.addEventListener('beforeunload', () => {
                Object.values(activeChannels).forEach(channel => {
                    if (channel && channel.unsubscribe) {
                        channel.unsubscribe();
                    }
                });
            });
        });
        
        console.log('‚úÖ Device Manager initialized with Supabase Realtime integration');
    </script>
</body>
</html>
