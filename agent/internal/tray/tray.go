package tray

import (
	"fmt"
	"log"
	"os"
	"os/exec"
	"path/filepath"

	"github.com/getlantern/systray"
	"github.com/stangtennis/remote-agent/internal/device"
	"github.com/stangtennis/remote-agent/internal/updater"
)

// Version of the agent - update this with each release
const Version = "v2.62.0"
const BuildDate = "2025-12-15"
const VersionString = Version + " (" + BuildDate + ")"

type TrayApp struct {
	device *device.Device
	onExit func()
}

func New(dev *device.Device, onExit func()) *TrayApp {
	return &TrayApp{
		device: dev,
		onExit: onExit,
	}
}

func (t *TrayApp) Run() {
	systray.Run(t.onReady, t.onExit)
}

func (t *TrayApp) onReady() {
	// Set up the system tray icon and menu
	systray.SetIcon(getIcon())
	systray.SetTitle("Remote")
	systray.SetTooltip(fmt.Sprintf("Remote Desktop Agent\nEnhed: %s", t.device.Name))

	// Add menu items
	mDeviceName := systray.AddMenuItem(fmt.Sprintf("Enhed: %s", t.device.Name), "")
	mDeviceName.Disable()

	mStatus := systray.AddMenuItem("Status: Online", "Aktuel forbindelsesstatus")
	mStatus.Disable()

	systray.AddSeparator()

	mConsole := systray.AddMenuItem("Vis konsol vindue", "Ã…bn live konsol output")
	mLogs := systray.AddMenuItem("Vis log fil", "Ã…bn log fil i editor")
	mVersion := systray.AddMenuItem(fmt.Sprintf("Version %s", Version), "Agent version")
	mVersion.Disable()

	systray.AddSeparator()

	mUpdate := systray.AddMenuItem("ðŸ”„ Tjek opdatering", "Tjek for nye versioner")
	mLogout := systray.AddMenuItem("Skift konto / Log ud", "Log ud og skift til anden konto")
	mQuit := systray.AddMenuItem("Afslut", "Luk agenten")

	// Handle menu clicks
	go func() {
		for {
			select {
			case <-mConsole.ClickedCh:
				openConsole()
			case <-mLogs.ClickedCh:
				openLogFile()
			case <-mUpdate.ClickedCh:
				log.Println("ðŸ”„ Update check requested from system tray")
				checkForUpdates()
			case <-mLogout.ClickedCh:
				log.Println("ðŸ”„ Logout requested from system tray")
				clearCredentialsAndRestart()
			case <-mQuit.ClickedCh:
				log.Println("ðŸ›‘ Exit requested from system tray")
				systray.Quit()
				return
			}
		}
	}()
}

func openConsole() {
	// Get the executable directory
	exePath, err := os.Executable()
	if err != nil {
		log.Printf("Failed to get executable path: %v", err)
		return
	}
	exeDir := filepath.Dir(exePath)
	logPath := filepath.Join(exeDir, "agent.log")

	// Check if log file exists
	if _, err := os.Stat(logPath); os.IsNotExist(err) {
		log.Printf("Log file does not exist: %s", logPath)
		return
	}

	// Open a PowerShell window that tails the log file
	log.Println("ðŸªŸ Opening console window with live logs...")

	// Use cmd to start PowerShell with proper escaping
	// This ensures the window opens correctly
	psCmd := fmt.Sprintf(`Get-Content -Path "%s" -Wait -Tail 50`, logPath)
	cmd := exec.Command("cmd", "/c", "start", "powershell", "-NoExit", "-Command", psCmd)

	if err := cmd.Start(); err != nil {
		log.Printf("Failed to open console: %v", err)
	} else {
		log.Printf("âœ… Console window opened for: %s", logPath)
	}
}

func openLogFile() {
	// Get the executable directory
	exePath, err := os.Executable()
	if err != nil {
		log.Printf("Failed to get executable path: %v", err)
		return
	}
	exeDir := filepath.Dir(exePath)
	logPath := filepath.Join(exeDir, "agent.log")

	// Check if log file exists
	if _, err := os.Stat(logPath); os.IsNotExist(err) {
		log.Printf("Log file does not exist: %s", logPath)
		return
	}

	// Open log file with default text editor
	log.Printf("ðŸ“„ Opening log file: %s", logPath)

	// Use notepad as it's always available on Windows
	cmd := exec.Command("notepad", logPath)
	if err := cmd.Start(); err != nil {
		log.Printf("Failed to open log file: %v", err)
	}
}

// clearCredentialsAndRestart clears saved credentials and restarts the agent
func clearCredentialsAndRestart() {
	// Get credentials path
	programData := os.Getenv("ProgramData")
	var credPath string
	if programData != "" {
		credPath = filepath.Join(programData, "RemoteDesktopAgent", ".credentials")
	} else {
		exePath, _ := os.Executable()
		credPath = filepath.Join(filepath.Dir(exePath), ".credentials")
	}

	// Remove credentials file
	if err := os.Remove(credPath); err != nil && !os.IsNotExist(err) {
		log.Printf("âš ï¸ Failed to remove credentials: %v", err)
	} else {
		log.Println("âœ… Credentials cleared")
	}

	// Restart the agent
	exePath, err := os.Executable()
	if err != nil {
		log.Printf("âŒ Failed to get executable path: %v", err)
		return
	}

	log.Println("ðŸ”„ Restarting agent for new login...")

	// Start new instance
	cmd := exec.Command(exePath)
	cmd.Start()

	// Exit current instance
	systray.Quit()
}

// getIcon returns a valid ICO file for the system tray
// Simple 16x16 blue computer monitor icon
func getIcon() []byte {
	// This is a valid ICO file (16x16, 32-bit color)
	// Icon design: Computer monitor in blue
	return []byte{
		// ICO Header (6 bytes)
		0x00, 0x00, // Reserved (must be 0)
		0x01, 0x00, // Type (1 = ICO)
		0x01, 0x00, // Number of images

		// ICONDIRENTRY (16 bytes)
		0x10,       // Width (16 pixels)
		0x10,       // Height (16 pixels)
		0x00,       // Color palette (0 = no palette)
		0x00,       // Reserved
		0x01, 0x00, // Color planes
		0x20, 0x00, // Bits per pixel (32-bit RGBA)
		0x28, 0x04, 0x00, 0x00, // Size of image data (1064 bytes)
		0x16, 0x00, 0x00, 0x00, // Offset to image data (22 bytes)

		// BMP Info Header (40 bytes)
		0x28, 0x00, 0x00, 0x00, // Header size (40 bytes)
		0x10, 0x00, 0x00, 0x00, // Width (16 pixels)
		0x20, 0x00, 0x00, 0x00, // Height (32 pixels, double for AND mask)
		0x01, 0x00, // Planes (1)
		0x20, 0x00, // Bits per pixel (32)
		0x00, 0x00, 0x00, 0x00, // Compression (none)
		0x00, 0x04, 0x00, 0x00, // Image size (1024 bytes)
		0x00, 0x00, 0x00, 0x00, // X pixels per meter (0)
		0x00, 0x00, 0x00, 0x00, // Y pixels per meter (0)
		0x00, 0x00, 0x00, 0x00, // Colors used (0 = all)
		0x00, 0x00, 0x00, 0x00, // Important colors (0 = all)

		// Pixel data (16x16 pixels, 32-bit BGRA format, bottom-up)
		// Row 0 (bottom) - transparent
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		// Row 1 - transparent
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		// Row 2 - base
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80, 0xFF,
		0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80, 0xFF, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		// Row 3 - stand
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80, 0xFF,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		// Row 4 - stand
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80, 0xFF,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		// Row 5 - bottom of monitor
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		// Row 6 - monitor border + screen
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0x00, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		// Row 7-12 - monitor screen (blue)
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0x00, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0x00, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0x00, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0x00, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0x00, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0x00, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF, 0x00, 0x60, 0xFF, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		// Row 13 - top of monitor
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0xFF,
		0xFF, 0x80, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		// Rows 14-15 - transparent
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	}
}

// checkForUpdates checks for available updates and shows notification
func checkForUpdates() {
	log.Println("ðŸ” Checking for updates...")

	u, err := updater.NewUpdater(Version)
	if err != nil {
		log.Printf("âŒ Failed to initialize updater: %v", err)
		return
	}

	if err := u.CheckForUpdate(); err != nil {
		log.Printf("âŒ Update check failed: %v", err)
		return
	}

	info := u.GetAvailableUpdate()
	if info == nil {
		log.Println("âœ… Agent is up to date")
		return
	}

	log.Printf("ðŸ†• Update available: %s (current: %s)", info.TagName, Version)
	log.Println("ðŸ“¥ Downloading update...")

	if err := u.DownloadUpdate(); err != nil {
		log.Printf("âŒ Download failed: %v", err)
		return
	}

	log.Println("âœ… Update downloaded! Installing...")

	// Install update (empty service name = run-once mode)
	if err := u.InstallUpdate(""); err != nil {
		log.Printf("âŒ Install failed: %v", err)
		return
	}

	log.Println("ðŸš€ Update installed, restarting...")
	systray.Quit()
}
